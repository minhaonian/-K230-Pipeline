<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>CanMV-K230 AI PipeLineèˆ‡ç¡¬é«”æ¶æ§‹äº’å‹•åœ–</title>
<style>
    :root {
        --sensor-bg: #e6e6e6;
        --frame-bg: #fff2cc;
        --ai-bg: #fce4d6;
        --osd-bg: #e2efda;
        --display-bg: #dae8fc;
        --arrow-color: #4c86c6;
        --ai-arrow-color: #e74c3c;
        --border-color: #444;
        --code-bg: #1e1e1e;
        --highlight-color: #ff0000;
        --highlight-glow: 0 0 15px rgba(255, 0, 0, 0.8);
    }

    body {
        font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    header {
        background-color: #2c3e50;
        color: white;
        padding: 8px 20px;
        font-size: 1.1em;
        font-weight: bold;
        flex-shrink: 0;
    }

    .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .left-panel {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        border-right: 2px solid #ccc;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
    }

    .left-panel::-webkit-scrollbar {
        width: 10px;
    }
    .left-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .left-panel::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .left-panel::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .right-panel {
        flex: 1;
        background-color: #fafafa;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chip-display {
        padding: 15px;
        background-color: #fff;
        border-bottom: 2px solid #ccc;
        flex-shrink: 0;
    }

    .code-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .code-scroll-area::-webkit-scrollbar {
        width: 10px;
    }
    .code-scroll-area::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .code-scroll-area::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .code-scroll-area::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .full-code-section {
        border: 3px solid #d9534f;
        border-radius: 8px;
        overflow: hidden;
        background-color: #fff;
        margin-bottom: 15px;
    }

    .full-code-header {
        background-color: #d9534f;
        color: white;
        padding: 6px 12px;
        font-weight: bold;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .full-code-body {
        background-color: var(--code-bg);
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
    }

    .full-code-text {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.8em;
        color: #d4d4d4;
        white-space: pre;
        line-height: 1.3;
        padding: 8px;
        counter-reset: line;
    }

    .code-line {
        display: block;
        position: relative;
        padding-left: 45px;
        transition: background-color 0.3s, border-left 0.3s;
        min-height: 1.3em;
        cursor: pointer;
    }

    .code-line:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .code-line::before {
        counter-increment: line;
        content: counter(line);
        position: absolute;
        left: 5px;
        width: 30px;
        text-align: right;
        color: #858585;
        user-select: none;
        font-size: 0.85em;
    }

    .code-line.highlight {
        background-color: rgba(255, 215, 0, 0.3);
        border-left: 4px solid #ffd700;
        padding-left: 41px;
    }

    .code-line.highlight::before {
        color: #ffd700;
        font-weight: bold;
    }

    .code-line.clickable {
        background-color: rgba(100, 150, 255, 0.1);
    }

    .code-line.clickable:hover {
        background-color: rgba(100, 150, 255, 0.2);
        border-left: 2px solid #6496ff;
        padding-left: 43px;
    }

    .full-code-body::-webkit-scrollbar {
        width: 8px;
    }
    .full-code-body::-webkit-scrollbar-track {
        background: #2d2d30;
        border-radius: 10px;
    }
    .full-code-body::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 10px;
    }
    .full-code-body::-webkit-scrollbar-thumb:hover {
        background: #777;
    }

    .flow-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 15px;
        padding-top: 25px;
    }

    .bypass-line {
        position: absolute;
        top: 0px;
        left: 10%;
        width: 80%;
        height: 35px;
        border-top: 3px solid var(--arrow-color);
        border-left: 3px solid var(--arrow-color);
        border-right: 3px solid var(--arrow-color);
        z-index: 0;
        border-radius: 10px 10px 0 0;
    }
    .bypass-label {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        padding: 1px 8px;
        color: var(--arrow-color);
        font-weight: bold;
        font-size: 0.85em;
        border: 1px solid #ddd;
        border-radius: 12px;
        z-index: 1;
    }

    .box {
        border: 2px solid var(--border-color);
        padding: 8px 2px;
        text-align: center;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        width: 18%;
        border-radius: 6px;
        font-size: 0.88em;
        background-color: #fff;
        z-index: 2;
        box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .box:hover { transform: translateY(-3px); }
    .box.active { border-color: #d9534f; box-shadow: 0 0 10px rgba(217, 83, 79, 0.6); transform: scale(1.05); }

    .sensor { background-color: var(--sensor-bg); }
    .frame { background-color: var(--frame-bg); }
    .ai { background-color: var(--ai-bg); border: 2px solid #d35400; }
    .osd { background-color: var(--osd-bg); }
    .display { background-color: var(--display-bg); }

    .arrow-right { flex-grow: 1; height: 2px; background-color: var(--arrow-color); margin: 0 5px; position: relative; }
    .arrow-right::after { content: ''; position: absolute; right: -6px; top: -5px; border-left: 8px solid var(--arrow-color); border-top: 5px solid transparent; border-bottom: 5px solid transparent; }

    .vertical-arrow-section { position: relative; height: 35px; width: 100%; margin-bottom: 5px; }
    .arrow-down {
        position: absolute; left: 50%; top: 0; transform: translateX(-50%);
        width: 4px; height: 100%; background-color: var(--ai-arrow-color);
    }
    .arrow-down::after {
        content: ''; position: absolute; bottom: 0; left: -8px;
        border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid var(--ai-arrow-color);
    }

    .ai-sub-container {
        border: 2px dashed #d35400;
        background-color: #fffdf9;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .sub-title { text-align: center; font-weight: bold; color: #d35400; margin-bottom: 8px; font-size: 0.95em; }
    .sub-flow { display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap; }
    .sub-box {
        flex: 1; min-width: 110px; padding: 8px 2px; border: 1px solid #888; border-radius: 5px;
        cursor: pointer; text-align: center; font-size: 0.8em; transition: all 0.2s; background: #fff;
    }
    .sub-box:hover { transform: scale(1.05); }
    .sub-box.active { border: 2px solid #d9534f; font-weight: bold; box-shadow: 0 0 8px rgba(217, 83, 79, 0.4); }

    .bg-init { background-color: #d0cece; }
    .bg-config { background-color: #b4c7e7; }
    .bg-pre { background-color: #dae8fc; }
    .bg-inf { background-color: #fce4d6; }
    .bg-post { background-color: #e2efda; }
    .bg-draw { background-color: #f4cccc; }
    .bg-nms { background-color: #ffd966; }
    .bg-coord { background-color: #c9daf8; }

    .detail-panel {
        background-color: #f8f9fa;
        border-left: 5px solid #2c3e50;
        padding: 12px;
        border-radius: 5px;
        display: none;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .detail-header { 
        font-size: 1.25em; 
        font-weight: bold; 
        color: #2c3e50; 
        margin-bottom: 10px; 
        border-bottom: 3px solid #3498db;
        padding-bottom: 6px;
    }
    .detail-text { 
        font-size: 1.05em; 
        line-height: 1.45; 
        color: #333; 
        margin-bottom: 10px; 
    }
    
    .detail-text b {
        color: #e74c3c;
        font-weight: 900;
    }
    
    .detail-text .key-point {
        background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
        padding: 12px 15px;
        border-left: 5px solid #ff9800;
        margin: 12px 0;
        border-radius: 6px;
        font-size: 1.1em;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.15);
    }
    
    .detail-text .key-point > b:first-child {
        display: block;
        font-size: 1.25em;
        color: #ff6f00;
        margin-bottom: 10px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-bottom: 2px solid #ffb74d;
        padding-bottom: 6px;
    }
    
    .detail-text .tech-spec {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 12px 15px;
        border-left: 5px solid #1976d2;
        margin: 12px 0;
        border-radius: 6px;
        font-size: 1.1em;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.15);
    }
    
    .detail-text .tech-spec > b:first-child {
        display: block;
        font-size: 1.25em;
        color: #0d47a1;
        margin-bottom: 10px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-bottom: 2px solid #42a5f5;
        padding-bottom: 6px;
    }
    
    .code-container {
        background-color: var(--code-bg);
        border-radius: 5px;
        padding: 10px;
        overflow-x: auto;
        position: relative;
        max-height: 350px;
        overflow-y: auto;
    }
    .code-text { 
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
        font-size: 0.85em;
        color: #d4d4d4; 
        white-space: pre-wrap;
        line-height: 1.25;
    }

    .chip-container {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: auto auto auto auto;
        gap: 6px;
        width: 100%;
        max-width: 600px;
        border: 3px solid #000;
        padding: 8px;
        background-color: #fff;
        position: relative;
        box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        margin: 0 auto;
    }
    .chip-label {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.8em;
        font-weight: bold;
        color: rgba(0,0,0,0.05);
        pointer-events: none;
        z-index: 0;
    }

    .hw-block {
        border: 2px solid #333;
        padding: 4px;
        text-align: center;
        font-size: 0.7em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #fff;
        min-height: 45px;
        transition: all 0.3s;
        position: relative;
        z-index: 1;
    }
    .hw-block span { display: block; }
    .hw-title { font-weight: bold; margin-bottom: 1px; font-size: 1.05em;}
    .hw-sub { font-size: 0.78em; color: #555; }

    .hw-block.highlight-hw {
        border-color: var(--highlight-color);
        box-shadow: var(--highlight-glow);
        transform: scale(1.05);
        z-index: 10;
        background-color: #fffbe6;
    }
    .hw-block.highlight-hw .hw-title {
        color: #000;
        font-weight: 900;
    }
    .hw-block.highlight-hw .hw-sub {
        color: #333;
        font-weight: 600;
    }

    .col-high-speed { grid-column: 1; grid-row: 1 / span 2; }
    .col-security { grid-column: 2; grid-row: 1; }
    .col-sysctl { grid-column: 3; grid-row: 1; }
    .col-pmu { grid-column: 4; grid-row: 1; }
    .col-ai { grid-column: 5; grid-row: 1 / span 2; }
    
    .col-cpu1 { grid-column: 2; grid-row: 2; border: 2px solid #000; }
    .col-cpu0 { grid-column: 3; grid-row: 2; }
    
    .col-low-speed { grid-column: 1; grid-row: 3 / span 2; }
    
    .mm-container {
        grid-column: 2 / span 3;
        grid-row: 3 / span 2;
        border: 2px solid #333;
        padding: 4px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 4px;
        background-color: #fff;
    }
    .mm-label { grid-column: 1 / span 3; text-align: center; font-weight: bold; margin-bottom: 3px; font-size: 0.9em; }

    .hw-isp { background-color: #bf9000; color: white; }
    .hw-video { background-color: #00b0f0; color: white; }
    .hw-display { background-color: #92d050; color: black; }
    .hw-3d { background-color: #d9d9d9; }
    .hw-gpu { background-color: #92d050; }

    .hw-isp.highlight-hw,
    .hw-video.highlight-hw {
        color: #000;
    }
    .hw-isp.highlight-hw .hw-title,
    .hw-video.highlight-hw .hw-title,
    .hw-display.highlight-hw .hw-title,
    .hw-gpu.highlight-hw .hw-title {
        color: #000;
    }

    .col-storage { grid-column: 5; grid-row: 3 / span 2; display: flex; flex-direction: column; gap: 2px; border: 1px solid #333; padding: 2px;}
    .hw-ddr { background-color: #f4b084; }
    .hw-share { background-color: #9bc2e6; }
    .hw-dma { background-color: #9bc2e6; }

    .line-indicator {
        font-size: 0.8em;
        color: #fff;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 1px 6px;
        border-radius: 3px;
    }

    .info-box {
        background: #e8f4f8; 
        border-left: 3px solid #2196F3; 
        padding: 10px; 
        border-radius: 4px; 
        margin-top: 12px;
    }
    .info-box h4 {
        margin-top: 0; 
        margin-bottom: 6px;
        color: #1976D2;
        font-size: 1em;
    }
    .info-box p, .info-box ul {
        margin: 4px 0; 
        font-size: 0.85em; 
        line-height: 1.4;
    }
    .info-box ul {
        padding-left: 18px;
    }
    .info-box li {
        margin: 2px 0;
    }

    .warning-box {
        background: #fff3cd; 
        border-left: 3px solid #ffc107; 
        padding: 10px; 
        border-radius: 4px; 
        margin-top: 12px;
    }
    .warning-box h4 {
        margin-top: 0; 
        margin-bottom: 6px;
        color: #856404;
        font-size: 1em;
    }
    .warning-box ul {
        margin: 4px 0; 
        padding-left: 18px;
        font-size: 0.85em; 
        line-height: 1.4;
    }
    .warning-box li {
        margin: 2px 0;
    }

    .success-box {
        background: #d4edda; 
        border-left: 3px solid #28a745; 
        padding: 10px; 
        border-radius: 4px; 
        margin-top: 12px; 
        margin-bottom: 20px;
    }
    .success-box h4 {
        margin-top: 0; 
        margin-bottom: 6px;
        color: #155724;
        font-size: 1em;
    }
    .success-box ul {
        margin: 4px 0; 
        padding-left: 18px;
        font-size: 0.85em; 
        line-height: 1.4;
    }
    .success-box li {
        margin: 2px 0;
    }

    .coverage-warning {
        background: #ffe6e6;
        border-left: 5px solid #ff4444;
        padding: 12px;
        margin-top: 15px;
        border-radius: 4px;
    }

    .coverage-warning h4 {
        color: #cc0000;
        margin-top: 0;
        margin-bottom: 8px;
    }

    .coverage-warning ul {
        margin: 4px 0;
        padding-left: 20px;
    }

    .coverage-warning li {
        color: #660000;
        margin: 4px 0;
    }

</style>
</head>
<body>

<header>CanMV-K230ï¼šYOLOv8 AI æµæ°´ç·šèˆ‡ SoC ç¡¬é«”å”åŒäº’å‹•åœ–ï¼ˆé›™å‘äº’å‹•ç‰ˆï¼‰</header>

<div class="main-container">
    <div class="left-panel">
        <div style="text-align: center; margin-bottom: 8px; color: #666; font-size: 0.85em;">
            <small>ğŸ’¡ é›™å‘äº’å‹•ï¼šé»æ“Šå·¦å´æµç¨‹åœ–æŸ¥çœ‹ä»£ç¢¼ â‡„ é»æ“Šå³å´ä»£ç¢¼è¡Œè·³è½‰åˆ°å°æ‡‰æµç¨‹</small>
        </div>

        <div class="flow-row">
            <div class="bypass-line"></div>
            <div class="bypass-label">ç›´é€šé¡¯ç¤º (é›¶å»¶é²)</div>

            <div class="box sensor" data-key="sensor" onclick="interact('sensor', this)">Sensor<br>æ”åƒé ­</div>
            <div class="arrow-right"></div>
            <div class="box frame" data-key="frame" onclick="interact('frame', this)">Frame<br>åœ–åƒå¹€</div>
            <div class="arrow-right"></div>
            <div class="box ai" data-key="ai" onclick="interact('ai', this)">AI<br>æ¨ç†æ ¸å¿ƒ</div>
            <div class="arrow-right"></div>
            <div class="box osd" data-key="osd" onclick="interact('osd', this)">OSD<br>ç¹ªåœ–å±¤</div>
            <div class="arrow-right"></div>
            <div class="box display" data-key="display" onclick="interact('display', this)">Display<br>é¡¯ç¤ºå±</div>
        </div>

        <div class="vertical-arrow-section">
            <div class="arrow-down"></div>
        </div>

        <div class="ai-sub-container">
            <div class="sub-title">â–¼ YOLOv8 å®Œæ•´ AI è™•ç†æµæ°´ç·š â–¼</div>
            <div class="sub-flow">
                <div class="sub-box bg-init" data-key="init" onclick="interact('init', this)">0. Init<br>æ¨¡å‹åˆå§‹åŒ–</div>
                <div class="sub-box bg-config" data-key="config" onclick="interact('config', this)">1. Config<br>è¨ˆç®—æ¯”ä¾‹</div>
                <div class="sub-box bg-pre" data-key="preprocess" onclick="interact('preprocess', this)">2. PreProcess<br>AI2D é è™•ç†</div>
                <div class="sub-box bg-inf" data-key="inference" onclick="interact('inference', this)">3. Inference<br>KPU æ¨ç†</div>
                <div class="sub-box bg-post" data-key="postprocess" onclick="interact('postprocess', this)">4. PostProcess<br>çµæœè™•ç†</div>
                <div class="sub-box bg-nms" data-key="nms" onclick="interact('nms', this)">5. NMS<br>éæ¥µå¤§å€¼æŠ‘åˆ¶</div>
                <div class="sub-box bg-coord" data-key="coord" onclick="interact('coord', this)">6. Coord<br>åæ¨™è½‰æ›</div>
                <div class="sub-box bg-draw" data-key="draw" onclick="interact('draw', this)">7. Draw<br>ç¹ªè£½çµæœ</div>
            </div>
        </div>

        <div id="detailPanel" class="detail-panel">
            <div id="dHeader" class="detail-header"></div>
            <div id="dText" class="detail-text"></div>
            <div class="code-container">
                <div id="dCode" class="code-text"></div>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="chip-display">
            <h3 style="margin-top:0; margin-bottom: 8px; font-size: 1.1em; text-align: center;">K230 SoC Block Diagram</h3>
            <div class="chip-container">
                <div class="chip-label">K230</div>

                <div class="hw-block col-high-speed" id="hw-highspeed">
                    <span class="hw-title">High Speed</span>
                    <span class="hw-sub">USB 2.0 OTG x2</span>
                    <span class="hw-sub">SD/eMMC</span>
                    <span class="hw-sub">SPI OPI/QPI</span>
                </div>

                <div class="hw-block col-security" id="hw-security">
                    <span class="hw-title">Security</span>
                    <span class="hw-sub">AES/SHA/OTP</span>
                </div>
                <div class="hw-block col-sysctl" id="hw-sysctl">
                    <span class="hw-title">SYSCTL</span>
                    <span class="hw-sub">Timer/WDT</span>
                </div>
                <div class="hw-block col-pmu" id="hw-pmu">
                    <span class="hw-title">PMU</span>
                    <span class="hw-sub">RTC/CLK</span>
                </div>

                <div class="hw-block col-ai" id="hw-ai-sub">
                    <span class="hw-title">AI Subsystem</span>
                    <div class="hw-block" id="hw-kpu" style="width:90%; border:1px solid #888; margin:2px;">
                        <b>KPU</b> (INT8/16)
                    </div>
                    <div class="hw-block" id="hw-ai-sram" style="width:90%; border:1px solid #888; margin:2px;">
                        SRAM 2MB
                    </div>
                    <div class="hw-block" id="hw-ai2d" style="width:90%; border:1px solid #888; margin:2px;">
                        <b>AI 2D Engine</b>
                    </div>
                </div>

                <div class="hw-block col-cpu1" id="hw-cpu1">
                    <span class="hw-title">CPU1 (Main)</span>
                    <span class="hw-sub">RISC-V 1.6GHz</span>
                    <span class="hw-sub">RVV1.0 Vector</span>
                </div>
                <div class="hw-block col-cpu0" id="hw-cpu0">
                    <span class="hw-title">CPU0</span>
                    <span class="hw-sub">RISC-V 800MHz</span>
                </div>

                <div class="hw-block col-low-speed" id="hw-lowspeed">
                    <span class="hw-title">Low Speed</span>
                    <span class="hw-sub">UART x5</span>
                    <span class="hw-sub">I2C x5</span>
                    <span class="hw-sub">PWM / ADC</span>
                    <span class="hw-sub">GPIO x64</span>
                </div>

                <div class="mm-container">
                    <div class="mm-label">Multi-Media Subsystem</div>
                    
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <div class="hw-block hw-isp" id="hw-vi">VI (HDR)</div>
                        <div class="hw-block hw-isp" id="hw-isp">ISP (4K30)</div>
                        <div class="hw-block hw-isp" id="hw-csi">MIPI CSI</div>
                    </div>

                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <div class="hw-block hw-video" id="hw-vpu">Video Subsystem<br>(H.264/265)</div>
                        <div class="hw-block hw-3d" id="hw-3d">3D Depth</div>
                    </div>

                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <div class="hw-block hw-display" id="hw-vo">Display VO</div>
                        <div class="hw-block hw-display" id="hw-dsi">MIPI DSI</div>
                        <div class="hw-block hw-gpu" id="hw-gpu">2.5D GPU</div>
                    </div>
                </div>

                <div class="col-storage">
                    <div style="text-align:center; font-weight:bold; font-size:0.75em;">Storage Mgmt</div>
                    <div class="hw-block hw-ddr" id="hw-ddr">DDR Subsystem<br>(LPDDR4)</div>
                    <div class="hw-block hw-share" id="hw-share">Share Memory</div>
                    <div class="hw-block hw-dma" id="hw-dma">2D GDMA / SDMA</div>
                </div>

            </div>
        </div>

        <div class="code-scroll-area">
            <div class="full-code-section">
                <div class="full-code-header">
                    ğŸ“„ å®Œæ•´ç¨‹åºä»£ç¢¼ (YOLOv8 æª¢æ¸¬æµç¨‹) - é»æ“Šä»£ç¢¼è¡Œè·³è½‰åˆ°å°æ‡‰æµç¨‹
                    <span class="line-indicator" id="lineIndicator">é»æ“Šå·¦å´æˆ–ä»£ç¢¼è¡ŒæŸ¥çœ‹å°æ‡‰æ¨¡å¡Š</span>
                </div>
                <div class="full-code-body" id="fullCodeBody">
                    <div class="full-code-text" id="fullCodeText"></div>
                </div>
            </div>

            <div class="info-box">
                <h4>ğŸ’¡ ä»£ç¢¼å®Œæ•´æ€§èªªæ˜</h4>
                <p>âœ… æœ¬ç¨‹åºåŒ…å«å®Œæ•´çš„ YOLOv8 ç›®æ¨™æª¢æ¸¬æµç¨‹ï¼ˆå…± <span id="totalLines">210+</span> è¡Œï¼‰<br>
                âœ… å¾æ”åƒé ­åˆå§‹åŒ–åˆ°å¯¦æ™‚æª¢æ¸¬è¼¸å‡ºçš„æ‰€æœ‰æ­¥é©Ÿ<br>
                âœ… åŒ…å«éŒ¯èª¤è™•ç†å’Œè³‡æºæ¸…ç†æ©Ÿåˆ¶<br>
                âœ… é»æ“Šå·¦å´æµç¨‹å¡Šæˆ–å³å´ä»£ç¢¼è¡Œå¯æŸ¥çœ‹å°æ‡‰å…§å®¹<br>
                âœ… æ”¯æŒå¯¦æ™‚æª¢æ¸¬ 30 ç¨®å¸¸è¦‹å°è±¡ï¼ˆCOCO æ•¸æ“šé›†é¡åˆ¥ï¼‰</p>
            </div>

            <div id="coverageWarning" class="coverage-warning" style="display:none;">
                <h4>âš ï¸ ä»£ç¢¼è¦†è“‹æª¢æŸ¥</h4>
                <div id="coverageDetails"></div>
            </div>

            <div class="warning-box">
                <h4>âš™ï¸ K230 èŠ¯ç‰‡ç¡¬é«”åŠ é€Ÿé—œéµé»</h4>
                <ul>
                    <li><b>MIPI CSI</b>ï¼š4 é€šé“é«˜é€Ÿæ”åƒé ­æ•¸æ“šæ¥æ”¶ï¼ˆé€Ÿåº¦å¯é” 4K@30fpsï¼‰</li>
                    <li><b>ISP</b>ï¼šåœ–åƒä¿¡è™Ÿè™•ç†å™¨ï¼Œè‡ªå‹•å®Œæˆå»å™ªã€ç™½å¹³è¡¡ã€è‰²å½©æ ¡æ­£</li>
                    <li><b>AI 2D Engine</b>ï¼šç¡¬é«”åœ–åƒé è™•ç†åŠ é€Ÿå™¨ï¼ˆResize/Padding ç„¡éœ€ CPUï¼‰</li>
                    <li><b>KPU</b>ï¼šç¥ç¶“ç¶²çµ¡æ¨ç†å¼•æ“ï¼ˆ3TOPS ç®—åŠ›ï¼Œæ”¯æŒ INT8 é‡åŒ–ï¼‰</li>
                    <li><b>2D GDMA</b>ï¼šåœ–å½¢ç¹ªè£½åŠ é€Ÿå¼•æ“ï¼ˆç¹ªè£½æª¢æ¸¬æ¡†å’Œæ–‡å­—ï¼‰</li>
                    <li><b>Display VO</b>ï¼šç¡¬é«”è¦–é »è¼¸å‡ºåˆæˆå™¨ï¼ˆç–ŠåŠ è¦–é »å±¤å’Œ OSD å±¤ï¼‰</li>
                </ul>
            </div>

            <div class="success-box">
                <h4>ğŸš€ K230 æ€§èƒ½å„ªåŒ–äº®é»</h4>
                <ul>
                    <li><b>é›¶å»¶é²é¡¯ç¤º</b>ï¼šCh0 è¦–é »æµç›´æ¥ç¶å®šé¡¯ç¤ºå±¤ï¼Œç„¡è»Ÿé«”ç·©è¡å»¶é²</li>
                    <li><b>é›™æ ¸ç•°æ§‹</b>ï¼šCPU0 (800MHz) é‹è¡Œå¯¦æ™‚ç³»çµ±ï¼ŒCPU1 (1.6GHz) é‹è¡Œ AI æ‡‰ç”¨</li>
                    <li><b>ç¡¬é«”æµæ°´ç·š</b>ï¼šISP â†’ AI2D â†’ KPU å…¨ç¡¬é«”åŠ é€Ÿï¼ŒCPU é›¶å¹²é </li>
                    <li><b>é›¶æ‹·è²å„ªåŒ–</b>ï¼što_numpy_ref() ç›´æ¥å¼•ç”¨å…§å­˜ï¼Œé¿å…æ•¸æ“šè¤‡è£½</li>
                    <li><b>å‘é‡åŠ é€Ÿ</b>ï¼šCPU1 RVV1.0 å‘é‡æŒ‡ä»¤åŠ é€Ÿ NMS ç­‰æ•¸çµ„é‹ç®—ï¼ˆæ¯”æ¨™é‡å¿« 4-8 å€ï¼‰</li>
                    <li><b>å…±äº«å…§å­˜</b>ï¼šCPUã€KPUã€ISP é€šéå…±äº«å…§å­˜é«˜æ•ˆäº¤æ›æ•¸æ“š</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const fullProgramCode = `import nncase_runtime as nn
import numpy as np
from media.sensor import *
from media.display import *
from media.media import *
import image
import time

# ==================== å…¨å±€åƒæ•¸é…ç½® ====================
DISPLAY_WIDTH = 1920
DISPLAY_HEIGHT = 1080
AI_RGB888P_WIDTH = 1280
AI_RGB888P_HEIGHT = 720

kmodel_path = "/sdcard/examples/kmodel/yolov8n_224.kmodel"
model_input_size = [224, 224]
confidence_threshold = 0.3
nms_threshold = 0.4
max_boxes_num = 50

labels = ["person", "bicycle", "car", "motorcycle", "airplane", "bus", 
          "train", "truck", "boat", "traffic light", "fire hydrant",
          "stop sign", "parking meter", "bench", "bird", "cat", "dog",
          "horse", "sheep", "cow", "elephant", "bear", "zebra", "giraffe",
          "backpack", "umbrella", "handbag", "tie", "suitcase", "frisbee"]

colors = [(255,0,0), (0,255,0), (0,0,255), (255,255,0), (255,0,255),
          (0,255,255), (128,0,0), (0,128,0), (0,0,128), (128,128,0)]

# ==================== 1. Letterbox åƒæ•¸è¨ˆç®— ====================
def letterbox_pad_param(input_size, output_size):
    """è¨ˆç®—ä¿æŒå¯¬é«˜æ¯”çš„ç¸®æ”¾å’Œ padding åƒæ•¸"""
    ratio_w = output_size[0] / input_size[0]
    ratio_h = output_size[1] / input_size[1]
    ratio = min(ratio_w, ratio_h)
    new_w = int(ratio * input_size[0])
    new_h = int(ratio * input_size[1])
    dw = (output_size[0] - new_w) / 2
    dh = (output_size[1] - new_h) / 2
    top = int(round(0))
    bottom = int(round(dh * 2 + 0.1))
    left = int(round(0))
    right = int(round(dw * 2 - 0.1))
    return top, bottom, left, right, ratio

# ==================== 2. NMS éæ¥µå¤§å€¼æŠ‘åˆ¶ ====================
def nms(boxes, scores, thresh):
    """å»é™¤é‡ç–Šçš„æª¢æ¸¬æ¡†"""
    x1 = boxes[:, 0]
    y1 = boxes[:, 1]
    x2 = boxes[:, 2]
    y2 = boxes[:, 3]
    areas = (x2 - x1 + 1) * (y2 - y1 + 1)
    order = np.argsort(scores, axis=0)[::-1]
    keep = []
    while order.size > 0:
        i = order[0]
        keep.append(i)
        xx1 = np.maximum(x1[i], x1[order[1:]])
        yy1 = np.maximum(y1[i], y1[order[1:]])
        xx2 = np.minimum(x2[i], x2[order[1:]])
        yy2 = np.minimum(y2[i], y2[order[1:]])
        w = np.maximum(0.0, xx2 - xx1 + 1)
        h = np.maximum(0.0, yy2 - yy1 + 1)
        inter = w * h
        ovr = inter / (areas[i] + areas[order[1:]] - inter)
        inds = np.where(ovr <= thresh)[0]
        order = order[inds + 1]
    return keep

# ==================== ä¸»ç¨‹åºåˆå§‹åŒ– ====================
sensor = None
ai2d = None
ai2d_builder = None
kpu = None
ai2d_input_tensor = None
kpu_input_tensor = None
ratio = 0

try:
    # ---------- 0. åˆå§‹åŒ– Sensor ----------
    print("[1/7] åˆå§‹åŒ–æ”åƒé ­...")
    sensor = Sensor()
    sensor.reset()
    
    # Ch0: é¡¯ç¤ºé€šé“ YUV420 1920x1080
    sensor.set_framesize(width=DISPLAY_WIDTH, height=DISPLAY_HEIGHT, chn=CAM_CHN_ID_0)
    sensor.set_pixformat(Sensor.YUV420SP, chn=CAM_CHN_ID_0)
    
    # Ch1: AI é€šé“ RGB888P 1280x720
    sensor.set_framesize(width=AI_RGB888P_WIDTH, height=AI_RGB888P_HEIGHT, chn=CAM_CHN_ID_1)
    sensor.set_pixformat(Sensor.RGBP888, chn=CAM_CHN_ID_1)
    
    # ç¶å®š Ch0 åˆ°é¡¯ç¤ºå±¤å¯¦ç¾é›¶å»¶é²
    sensor_bind_info = sensor.bind_info(x=0, y=0, chn=CAM_CHN_ID_0)
    Display.init(Display.LT9611, width=DISPLAY_WIDTH, height=DISPLAY_HEIGHT, osd_num=1, to_ide=True)
    Display.bind_layer(**sensor_bind_info, layer=Display.LAYER_VIDEO1)
    
    # å•Ÿå‹• Sensor
    sensor.run()
    print("âœ“ æ”åƒé ­åˆå§‹åŒ–å®Œæˆ")
    
    # ---------- 1. åˆå§‹åŒ– AI2D é è™•ç† ----------
    print("[2/7] åˆå§‹åŒ– AI2D é è™•ç†...")
    ai2d = nn.ai2d()
    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)
    
    # è¨ˆç®— letterbox åƒæ•¸
    top, bottom, left, right, ratio = letterbox_pad_param([AI_RGB888P_WIDTH, AI_RGB888P_HEIGHT], model_input_size)
    ai2d.set_pad_param(True, [0,0,0,0,top,bottom,left,right], 0, [128,128,128])
    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)
    
    # æ§‹å»º AI2D æµç¨‹
    ai2d_builder = ai2d.build([1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH], [1,3,model_input_size[1],model_input_size[0]])
    print("âœ“ AI2D é è™•ç†é…ç½®å®Œæˆ")
    
    # ---------- 2. åˆå§‹åŒ– KPU æ¨¡å‹ ----------
    print("[3/7] åŠ è¼‰ YOLOv8 æ¨¡å‹...")
    kpu = nn.kpu()
    kpu.load_kmodel(kmodel_path)
    print("âœ“ æ¨¡å‹åŠ è¼‰æˆåŠŸ")
    
    # æº–å‚™è¼¸å…¥è¼¸å‡º tensor
    ai2d_input_tensor = nn.from_numpy(np.zeros((1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH), dtype=np.uint8))
    kpu_input_tensor = nn.from_numpy(np.zeros((1,3,model_input_size[1],model_input_size[0]), dtype=np.uint8))
    
    # ---------- 3. å‰µå»º OSD åœ–å±¤ ----------
    print("[4/7] å‰µå»º OSD åœ–å±¤...")
    osd_img = image.Image(DISPLAY_WIDTH, DISPLAY_HEIGHT, image.ARGB8888)
    print("âœ“ OSD åœ–å±¤å‰µå»ºå®Œæˆ")
    
    # ==================== ä¸»å¾ªç’° ====================
    print("[5/7] é€²å…¥æª¢æ¸¬ä¸»å¾ªç’°...")
    frame_count = 0
    while True:
        # ===== ç²å–åœ–åƒå¹€ =====
        img = sensor.snapshot(chn=CAM_CHN_ID_1)
        img_np = img.to_numpy_ref()
        ai2d_input_tensor = nn.from_numpy(img_np)
        
        # ===== AI2D é è™•ç† =====
        ai2d_builder.run(ai2d_input_tensor, kpu_input_tensor)
        
        # ===== KPU æ¨ç† =====
        kpu.set_input_tensor(0, kpu_input_tensor)
        kpu.run()
        
        # ===== ç²å–æ¨ç†çµæœ =====
        results = []
        for i in range(kpu.outputs_size()):
            output_tensor = kpu.get_output_tensor(i)
            result = output_tensor.to_numpy()
            results.append(result)
        
        # ===== å¾Œè™•ç†ï¼šè§£æè¼¸å‡º =====
        output_data = results[0][0].transpose()
        boxes_ori = output_data[:, 0:4]
        class_ori = output_data[:, 4:]
        class_res = np.argmax(class_ori, axis=-1)
        scores_ = np.max(class_ori, axis=-1)
        
        # ===== ç¯©é¸èˆ‡åæ¨™è½‰æ› =====
        boxes, inds, scores = [], [], []
        for i in range(len(boxes_ori)):
            if scores_[i] > confidence_threshold:
                x, y, w, h = boxes_ori[i]
                x1 = int((x - 0.5 * w) / ratio)
                y1 = int((y - 0.5 * h) / ratio)
                x2 = int((x + 0.5 * w) / ratio)
                y2 = int((y + 0.5 * h) / ratio)
                boxes.append([x1, y1, x2, y2])
                inds.append(class_res[i])
                scores.append(scores_[i])
        
        # ===== NMS å»é‡ =====
        if len(boxes) > 0:
            boxes = np.array(boxes)
            scores = np.array(scores)
            keep = nms(boxes, scores, nms_threshold)
            
            dets = np.concatenate((boxes, scores.reshape((len(boxes), 1)), inds.reshape((len(boxes), 1))), axis=1)
            det_res = [dets[i] for i in keep]
            det_res = np.array(det_res)[:max_boxes_num, :]
        else:
            det_res = np.array([])
        
        # ===== ç¹ªè£½çµæœ =====
        osd_img.clear()
        for det in det_res:
            x1, y1, x2, y2, score, class_id = det
            draw_x = int(x1 * DISPLAY_WIDTH // AI_RGB888P_WIDTH)
            draw_y = int(y1 * DISPLAY_HEIGHT // AI_RGB888P_HEIGHT)
            draw_w = int((x2 - x1) * DISPLAY_WIDTH // AI_RGB888P_WIDTH)
            draw_h = int((y2 - y1) * DISPLAY_HEIGHT // AI_RGB888P_HEIGHT)
            
            osd_img.draw_rectangle(draw_x, draw_y, draw_w, draw_h, color=colors[int(class_id) % 10], thickness=4)
            label = labels[int(class_id)] + " {:.2f}".format(score)
            osd_img.draw_string_advanced(draw_x, max(0, draw_y-50), 24, label, color=colors[int(class_id) % 10])
        
        # ===== é¡¯ç¤º OSD =====
        Display.show_image(osd_img)
        gc.collect()
        
        frame_count += 1
        if frame_count % 30 == 0:
            print(f"âœ“ å·²è™•ç† {frame_count} å¹€ï¼Œæª¢æ¸¬åˆ° {len(det_res)} å€‹å°è±¡")

except KeyboardInterrupt:
    print("\\n[6/7] ç”¨æˆ¶ä¸­æ–·ç¨‹åº")
except Exception as e:
    print(f"[ERROR] ç™¼ç”ŸéŒ¯èª¤: {e}")
    import traceback
    traceback.print_exc()

finally:
    # æ¸…ç†è³‡æº
    print("[7/7] æ¸…ç†è³‡æº...")
    if sensor:
        sensor.stop()
        print("  âœ“ Sensor å·²åœæ­¢")
    if ai2d:
        del ai2d
        print("  âœ“ AI2D å·²é‡‹æ”¾")
    if kpu:
        del kpu
        print("  âœ“ KPU å·²é‡‹æ”¾")
    Display.deinit()
    print("  âœ“ Display å·²é—œé–‰")
    print("ç¨‹åºçµæŸ")`;

    // è¡Œè™Ÿæ˜ å°„è¡¨
    const lineRanges = {
        'globals': [1, 29],        // å°å…¥å’Œå…¨å±€è®Šé‡
        'config': [30, 48],        // letterbox åƒæ•¸è¨ˆç®—
        'nms_func': [49, 70],      // NMS å‡½æ•¸å®šç¾©
        'var_init': [71, 82],      // è®Šé‡åˆå§‹åŒ–
        'sensor': [84, 105],       // Sensor åˆå§‹åŒ–
        'init': [103, 126],        // AI2D + KPU åˆå§‹åŒ–
        'osd': [128, 131],         // OSD åœ–å±¤å‰µå»º
        'loop_start': [133, 135],  // ä¸»å¾ªç’°é–‹å§‹
        'frame': [136, 139],       // ç²å–åœ–åƒå¹€
        'preprocess': [141, 142],  // AI2D é è™•ç†
        'inference': [144, 153],   // KPU æ¨ç†
        'postprocess': [154, 173], // å¾Œè™•ç†
        'nms': [175, 186],         // NMS å»é‡
        'coord': [175, 186],       // åæ¨™æ•´ç†ï¼ˆåŒNMSï¼‰
        'draw': [187, 199],        // ç¹ªè£½çµæœ
        'display': [200, 202],     // é¡¯ç¤º OSD
        'loop_end': [203, 206],    // å¾ªç’°çµæŸ
        'except': [207, 213],      // ç•°å¸¸è™•ç†
        'finally': [214, 227],     // è³‡æºæ¸…ç†
        'ai': [103, 126]           // AI æ¨ç†æ ¸å¿ƒï¼ˆåŒinitï¼‰
    };

    const content = {
        'sensor': {
            title: 'ğŸ“· Sensor æ”åƒé ­åˆå§‹åŒ–',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šé›™é€šé“æ”åƒé ­é…ç½®</b><br><br>
1ï¸âƒ£ <b>Ch0 é¡¯ç¤ºé€šé“</b>ï¼šè¼¸å‡º 1920Ã—1080 YUV420 æ ¼å¼è¦–é »<br>
â€¢ <b>é›¶å»¶é²ç¶å®š</b>ï¼šé€šé <code>bind_layer()</code> ç›´æ¥é€£æ¥åˆ° Display ç¡¬é«”å±¤<br>
â€¢ æ•¸æ“šæµï¼šMIPI CSI â†’ ISP â†’ VI â†’ Display VOï¼ˆå…¨ç¡¬é«”æµæ°´ç·šï¼‰<br>
â€¢ ç”¨é€”ï¼šå¯¦æ™‚é è¦½ç•«é¢ï¼Œç„¡è»Ÿé«”ç·©è¡å»¶é²<br><br>
2ï¸âƒ£ <b>Ch1 AI é€šé“</b>ï¼šè¼¸å‡º 1280Ã—720 RGB888P æ ¼å¼åœ–åƒ<br>
â€¢ æ•¸æ“šæµï¼šMIPI CSI â†’ ISP â†’ VI â†’ Share Memory<br>
â€¢ ç”¨é€”ï¼šé€å…¥ AI2D å’Œ KPU é€²è¡Œç›®æ¨™æª¢æ¸¬<br>
â€¢ ç‚ºä»€éº¼ç”¨è¼ƒä½åˆ†è¾¨ç‡ï¼Ÿé™ä½è¨ˆç®—é‡ï¼Œæå‡æ¨ç†é€Ÿåº¦ï¼ˆ1280Ã—720 æ¯” 1920Ã—1080 å°‘ 40% åƒç´ ï¼‰<br><br>
3ï¸âƒ£ <b>ç¡¬é«”æ¨¡å¡Šå·¥ä½œåˆ†å·¥</b><br>
â€¢ <b>MIPI CSI</b>ï¼š4 é€šé“é«˜é€Ÿæ¥å£ï¼Œæ¥æ”¶æ”åƒé ­åŸå§‹æ•¸æ“šï¼ˆæœ€é«˜ 4K@30fpsï¼‰<br>
â€¢ <b>ISP</b>ï¼šè‡ªå‹•åŸ·è¡Œé™å™ªã€ç™½å¹³è¡¡ã€è‰²å½©æ ¡æ­£ã€HDR åˆæˆ<br>
â€¢ <b>VI (Video Input)</b>ï¼šå°‡ ISP è™•ç†å¾Œçš„æ•¸æ“šåˆ†ç™¼åˆ°å…©å€‹é€šé“
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>YUV420SP æ ¼å¼</b>ï¼ˆCh0ï¼‰ï¼šY å¹³é¢ï¼šäº®åº¦ä¿¡æ¯ï¼ˆ1920Ã—1080 = 2,073,600 å­—ç¯€ï¼‰ï¼›UV å¹³é¢ï¼šè‰²åº¦ä¿¡æ¯ï¼ˆ960Ã—540Ã—2 = 1,036,800 å­—ç¯€ï¼‰ï¼›ç¸½å…±ç´„ 3MB/å¹€ï¼Œæ¯” RGB888 ç¯€çœ 50% å…§å­˜<br><br>
<b>RGB888P æ ¼å¼</b>ï¼ˆCh1ï¼‰ï¼šRã€Gã€B ä¸‰å€‹ç¨ç«‹å¹³é¢ï¼ˆPlanarï¼‰ï¼Œæ¯å€‹å¹³é¢ 1280Ã—720ï¼›ç¸½å…± 1280Ã—720Ã—3 â‰ˆ 2.76MB/å¹€ï¼›P (Planar) æ ¼å¼é©åˆ AI2D ç¡¬é«”è™•ç†ï¼ˆé€£çºŒå…§å­˜è¨ªå•æ›´å¿«ï¼‰<br><br>
<b>é›¶å»¶é²é¡¯ç¤ºåŸç†</b>ï¼šå‚³çµ±æ–¹å¼ï¼šISP â†’ DDR â†’ CPU â†’ Displayï¼ˆéœ€è¦ 3 æ¬¡æ•¸æ“šæ¬ç§»ï¼‰ï¼›K230 æ–¹å¼ï¼šISP â†’ Display VOï¼ˆç¡¬é«”ç›´é€£ï¼Œ0 æ¬¡ CPU å¹²é ï¼‰ï¼›å»¶é²å°æ¯”ï¼šå‚³çµ± ~50msï¼ŒK230 ~2ms
</div>`,
            code: `# ---------- 0. åˆå§‹åŒ– Sensor ----------
print("[1/7] åˆå§‹åŒ–æ”åƒé ­...")
sensor = Sensor()
sensor.reset()

# Ch0: é¡¯ç¤ºé€šé“ YUV420 1920x1080
sensor.set_framesize(width=DISPLAY_WIDTH, height=DISPLAY_HEIGHT, chn=CAM_CHN_ID_0)
sensor.set_pixformat(Sensor.YUV420SP, chn=CAM_CHN_ID_0)

# Ch1: AI é€šé“ RGB888P 1280x720
sensor.set_framesize(width=AI_RGB888P_WIDTH, height=AI_RGB888P_HEIGHT, chn=CAM_CHN_ID_1)
sensor.set_pixformat(Sensor.RGBP888, chn=CAM_CHN_ID_1)

# ç¶å®š Ch0 åˆ°é¡¯ç¤ºå±¤å¯¦ç¾é›¶å»¶é²
sensor_bind_info = sensor.bind_info(x=0, y=0, chn=CAM_CHN_ID_0)
Display.init(Display.LT9611, width=DISPLAY_WIDTH, height=DISPLAY_HEIGHT, osd_num=1, to_ide=True)
Display.bind_layer(**sensor_bind_info, layer=Display.LAYER_VIDEO1)

# å•Ÿå‹• Sensor
sensor.run()
print("âœ“ æ”åƒé ­åˆå§‹åŒ–å®Œæˆ")`,
            targets: ['hw-csi', 'hw-isp', 'hw-vi', 'hw-vo']
        },
        'frame': {
            title: 'ğŸ–¼ï¸ Frame åœ–åƒå¹€ç²å–',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šé›¶æ‹·è²å…§å­˜è¨ªå•</b><br><br>
1ï¸âƒ£ <b>snapshot() æ–¹æ³•</b>ï¼šå¾ Ch1 é€šé“æŠ“å–ä¸€å¹€ 1280Ã—720 RGB åœ–åƒï¼›æ•¸æ“šå­˜å„²ä½ç½®ï¼š<b>DDR å…§å­˜</b>æˆ–<b>å…±äº«å…§å­˜å€åŸŸ</b>ï¼›è¿”å› Image å°è±¡ï¼ˆå°è£äº†å…§å­˜åœ°å€æŒ‡é‡ï¼‰<br><br>
2ï¸âƒ£ <b>to_numpy_ref() é›¶æ‹·è²æŠ€è¡“</b>ï¼šå‚³çµ± <code>to_numpy()</code>ï¼šè¤‡è£½æ•¸æ“šåˆ°æ–°çš„ NumPy æ•¸çµ„ï¼ˆæ…¢ï¼‰ï¼›å„ªåŒ– <code>to_numpy_ref()</code>ï¼šç›´æ¥è¿”å›å…§å­˜å¼•ç”¨ï¼ˆå¿«ï¼‰ï¼›æ•ˆæœï¼šé¿å… 2.76MB æ•¸æ“šè¤‡è£½ï¼Œç¯€çœç´„ 10ms<br><br>
3ï¸âƒ£ <b>å…§å­˜å…±äº«æ©Ÿåˆ¶</b>ï¼šSensor â†’ Share Memory â†’ AI2D â†’ KPUï¼›æ‰€æœ‰æ¨¡å¡Šè¨ªå•<b>åŒä¸€å¡Šç‰©ç†å…§å­˜</b>ï¼Œç„¡éœ€æ•¸æ“šæ¬ç§»ï¼›CPU åªè² è²¬å‚³éå…§å­˜åœ°å€æŒ‡é‡ï¼ˆ8 å­—ç¯€ï¼‰ï¼Œä¸è™•ç† 2.76MB åœ–åƒæ•¸æ“š
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>å…§å­˜å¸ƒå±€</b>ï¼ˆRGB888P æ ¼å¼ï¼‰ï¼š[R å¹³é¢: 1280Ã—720 å­—ç¯€] [G å¹³é¢: 1280Ã—720 å­—ç¯€] [B å¹³é¢: 1280Ã—720 å­—ç¯€] ç¸½å…±é€£çºŒçš„ 2,764,800 å­—ç¯€å…§å­˜å¡Š<br><br>
<b>æ€§èƒ½å°æ¯”</b>ï¼ˆæ¯å¹€è™•ç†æ™‚é–“ï¼‰ï¼šè¤‡è£½æ–¹å¼ï¼šmemcpy() 2.76MB â‰ˆ 12msï¼ˆDDR å¸¶å¯¬ ~230MB/sï¼‰ï¼›å¼•ç”¨æ–¹å¼ï¼šå‚³éæŒ‡é‡ < 0.1msï¼›30fps è¦–é »æµï¼šç¯€çœ 360ms/ç§’ = 36% CPU æ™‚é–“<br><br>
<b>from_numpy() è½‰æ›</b>ï¼šå°‡ NumPy æ•¸çµ„åŒ…è£æˆ nncase Tensor å°è±¡ï¼›ä¸æ”¹è®Šæ•¸æ“šå…§å®¹ï¼Œåªæ”¹è®Šæ•¸æ“šçµæ§‹æè¿°ï¼›AI2D å’Œ KPU è¦æ±‚è¼¸å…¥å¿…é ˆæ˜¯ Tensor æ ¼å¼
</div>`,
            code: `# ===== ç²å–åœ–åƒå¹€ =====
img = sensor.snapshot(chn=CAM_CHN_ID_1)
img_np = img.to_numpy_ref()
ai2d_input_tensor = nn.from_numpy(img_np)`,
            targets: ['hw-ddr', 'hw-share', 'hw-cpu1']
        },
        'ai': {
            title: 'ğŸ¤– AI æ¨ç†æ ¸å¿ƒç¸½è¦½',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šAI å­ç³»çµ±ä¸‰å¤§çµ„ä»¶</b><br><br>
1ï¸âƒ£ <b>AI 2D Engineï¼ˆåœ–åƒé è™•ç†ç¡¬é«”ï¼‰</b>ï¼šåŠŸèƒ½ï¼šResizeã€Cropã€Paddingã€æ ¼å¼è½‰æ›ã€è‰²å½©ç©ºé–“è½‰æ›ï¼›æ€§èƒ½ï¼šè™•ç† 1280Ã—720 åœ–åƒåƒ…éœ€ <b>2ms</b>ï¼ˆCPU è»Ÿé«”éœ€è¦ 50msï¼‰ï¼›åŸç†ï¼šå°ˆç”¨ DMA å¼•æ“ + é›™ç·šæ€§æ’å€¼ç¡¬é«”é›»è·¯<br><br>
2ï¸âƒ£ <b>KPUï¼ˆç¥ç¶“ç¶²çµ¡æ¨ç†å¼•æ“ï¼‰</b>ï¼šç®—åŠ›ï¼š<b>3 TOPS</b>ï¼ˆæ¯ç§’ 3 è¬å„„æ¬¡ INT8 é‹ç®—ï¼‰ï¼›æ¶æ§‹ï¼šRISC-V å‘é‡æ“´å±• + å°ˆç”¨ MAC é™£åˆ—ï¼ˆä¹˜åŠ å™¨ï¼‰ï¼›æ”¯æŒï¼šå·ç©ã€æ± åŒ–ã€æ¿€æ´»å‡½æ•¸ï¼ˆReLUã€Sigmoidï¼‰ã€å…¨é€£æ¥å±¤ï¼›é‡åŒ–ï¼šINT8/INT16 é‡åŒ–æ¨ç†ï¼ˆæ¯” FP32 å¿« 4 å€ï¼Œé«”ç©å° 4 å€ï¼‰<br><br>
3ï¸âƒ£ <b>AI SRAMï¼ˆé«˜é€Ÿç·©å­˜ï¼‰</b>ï¼šå®¹é‡ï¼š2MBï¼›ä½œç”¨ï¼šç·©å­˜ä¸­é–“å±¤ç‰¹å¾µåœ–ï¼Œæ¸›å°‘è¨ªå• DDR æ¬¡æ•¸ï¼›é€Ÿåº¦ï¼šSRAM è¨ªå•å»¶é² 1-2 é€±æœŸï¼ŒDDR è¨ªå•å»¶é² 100+ é€±æœŸ
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>AI2D é…ç½®åƒæ•¸</b>ï¼š<code>set_dtype()</code>ï¼šè¼¸å…¥è¼¸å‡ºæ ¼å¼ NCHWï¼ˆBatch Ã— Channel Ã— Height Ã— Widthï¼‰ï¼›<code>set_pad_param()</code>ï¼šä¸Šä¸‹å·¦å³ Padding åƒç´ æ•¸ + å¡«å……é¡è‰²ï¼›<code>set_resize_param()</code>ï¼šæ’å€¼æ–¹æ³•ï¼ˆé›™ç·šæ€§ï¼‰+ å°é½Šæ¨¡å¼ï¼ˆåŠåƒç´ ï¼‰ï¼›<code>build()</code>ï¼šç·¨è­¯ç”Ÿæˆç¡¬é«”æµæ°´ç·šæŒ‡ä»¤<br><br>
<b>KPU æ¨¡å‹åŠ è¼‰</b>ï¼š<code>load_kmodel()</code>ï¼šå¾ SD å¡è®€å– .kmodel æ–‡ä»¶ï¼›æ–‡ä»¶çµæ§‹ï¼šç¶²çµ¡çµæ§‹ + é‡åŒ–åƒæ•¸ + æ¬Šé‡æ•¸æ“šï¼›YOLOv8n-224 æ¨¡å‹å¤§å°ï¼šç´„ 6MBï¼ˆINT8 é‡åŒ–å¾Œï¼‰<br><br>
<b>ç¡¬é«”æµæ°´ç·šä¸¦è¡Œ</b>ï¼šéšæ®µ1ï¼šAI2D è™•ç†ç¬¬ N å¹€ï¼›éšæ®µ2ï¼šKPU æ¨ç†ç¬¬ N-1 å¹€ï¼›éšæ®µ3ï¼šCPU å¾Œè™•ç†ç¬¬ N-2 å¹€çµæœï¼›å¯¦ç¾ 3 å€åŠ é€Ÿï¼ˆ30fps â†’ ç†è«–å¯é” 90fpsï¼‰
</div>`,
            code: `# ---------- 1. åˆå§‹åŒ– AI2D é è™•ç† ----------
print("[2/7] åˆå§‹åŒ– AI2D é è™•ç†...")
ai2d = nn.ai2d()
ai2d.set_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)

# è¨ˆç®— letterbox åƒæ•¸
top, bottom, left, right, ratio = letterbox_pad_param([AI_RGB888P_WIDTH, AI_RGB888P_HEIGHT], model_input_size)
ai2d.set_pad_param(True, [0,0,0,0,top,bottom,left,right], 0, [128,128,128])
ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)

# æ§‹å»º AI2D æµç¨‹
ai2d_builder = ai2d.build([1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH], [1,3,model_input_size[1],model_input_size[0]])
print("âœ“ AI2D é è™•ç†é…ç½®å®Œæˆ")

# ---------- 2. åˆå§‹åŒ– KPU æ¨¡å‹ ----------
print("[3/7] åŠ è¼‰ YOLOv8 æ¨¡å‹...")
kpu = nn.kpu()
kpu.load_kmodel(kmodel_path)
print("âœ“ æ¨¡å‹åŠ è¼‰æˆåŠŸ")

# æº–å‚™è¼¸å…¥è¼¸å‡º tensor
ai2d_input_tensor = nn.from_numpy(np.zeros((1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH), dtype=np.uint8))
kpu_input_tensor = nn.from_numpy(np.zeros((1,3,model_input_size[1],model_input_size[0]), dtype=np.uint8))`,
            targets: ['hw-ai-sub', 'hw-kpu', 'hw-ai2d', 'hw-ai-sram']
        },
        'osd': {
            title: 'ğŸ¨ OSD ç¹ªåœ–å±¤å‰µå»º',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šé€æ˜åœ–å±¤ç–ŠåŠ æŠ€è¡“</b><br><br>
1ï¸âƒ£ <b>ARGB8888 æ ¼å¼</b>ï¼šA (Alpha)ï¼šé€æ˜åº¦é€šé“ï¼ˆ0=å®Œå…¨é€æ˜ï¼Œ255=å®Œå…¨ä¸é€æ˜ï¼‰ï¼›RGBï¼šç´…ç¶ è—ä¸‰åŸè‰²å„ 8 ä½ï¼ˆ256 ç´šï¼‰ï¼›æ¯åƒç´  4 å­—ç¯€ï¼Œ1920Ã—1080 åœ–å±¤éœ€è¦ <b>8.3MB</b> å…§å­˜<br><br>
2ï¸âƒ£ <b>åˆ†è¾¨ç‡åŒ¹é…</b>ï¼šOSD å±¤å¿…é ˆèˆ‡é¡¯ç¤ºå±åˆ†è¾¨ç‡ç›¸åŒï¼ˆ1920Ã—1080ï¼‰ï¼›åŸå› ï¼šç¢ºä¿æª¢æ¸¬æ¡†åº§æ¨™ç²¾ç¢ºå°æ‡‰å¯¦éš›ç•«é¢ä½ç½®ï¼›AI è¼¸å‡ºæ˜¯ 1280Ã—720 åº§æ¨™ï¼Œéœ€è¦ç¸®æ”¾åˆ° 1920Ã—1080<br><br>
3ï¸âƒ£ <b>åœ–å±¤åˆæˆé‚è¼¯</b>ï¼šLayer 1ï¼ˆåº•å±¤ï¼‰ï¼šå¯¦æ™‚è¦–é »æµï¼ˆä¾†è‡ª Sensor Ch0ï¼‰ï¼›Layer 2ï¼ˆä¸Šå±¤ï¼‰ï¼šOSD é€æ˜åœ–å±¤ï¼ˆæª¢æ¸¬æ¡†å’Œæ¨™ç±¤ï¼‰ï¼›åˆæˆå…¬å¼ï¼š<code>æœ€çµ‚é¡è‰² = åº•å±¤é¡è‰² Ã— (1-Alpha) + ä¸Šå±¤é¡è‰² Ã— Alpha</code>
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>å…§å­˜åˆ†é…</b>ï¼š<code>image.Image()</code> åœ¨ DDR ä¸­åˆ†é… 8.3MB é€£çºŒå…§å­˜ï¼›åˆå§‹ç‹€æ…‹ï¼šå…¨é€æ˜ï¼ˆAlpha=0ï¼Œæ‰€æœ‰åƒç´ ä¸å¯è¦‹ï¼‰ï¼›ç¹ªè£½æ™‚ä¿®æ”¹ç‰¹å®šåƒç´ çš„ ARGB å€¼<br><br>
<b>ç¡¬é«”åŠ é€Ÿè·¯å¾‘</b>ï¼ˆå¯èƒ½ä½¿ç”¨çš„æ¨¡å¡Šï¼‰ï¼š<b>2D GDMA</b>ï¼šå¿«é€Ÿå¡«å……çŸ©å½¢å€åŸŸï¼ˆdraw_rectangleï¼‰ï¼›<b>GPU 2.5D</b>ï¼šå­—é«”æ¸²æŸ“å’Œåé‹¸é½’ï¼ˆdraw_string_advancedï¼‰ï¼›<b>Display VO</b>ï¼šç¡¬é«” Alpha Blendingï¼ˆåœ–å±¤åˆæˆï¼‰<br><br>
<b>é¡¯ç¤ºåˆ·æ–°æµç¨‹</b>ï¼š1. CPU ä¿®æ”¹ OSD å±¤å…§å­˜ï¼ˆç¹ªè£½æª¢æ¸¬æ¡†ï¼‰ï¼›2. èª¿ç”¨ <code>Display.show_image()</code> é€šçŸ¥ç¡¬é«”ï¼›3. Display VO è‡ªå‹•å°‡ OSD å±¤ç–ŠåŠ åˆ°è¦–é »å±¤ï¼›4. MIPI DSI è¼¸å‡ºåˆæˆå¾Œçš„ç•«é¢åˆ°å±å¹•
</div>`,
            code: `# ---------- 3. å‰µå»º OSD åœ–å±¤ ----------
print("[4/7] å‰µå»º OSD åœ–å±¤...")
osd_img = image.Image(DISPLAY_WIDTH, DISPLAY_HEIGHT, image.ARGB8888)
print("âœ“ OSD åœ–å±¤å‰µå»ºå®Œæˆ")`,
            targets: ['hw-ddr', 'hw-gpu', 'hw-vo']
        },
        'display': {
            title: 'ğŸ–¥ï¸ Display é¡¯ç¤ºè¼¸å‡º',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šå¤šå±¤ç¡¬é«”åˆæˆé¡¯ç¤º</b><br><br>
1ï¸âƒ£ <b>Display VOï¼ˆVideo Outputï¼‰æ¨¡å¡Š</b>ï¼šåŠŸèƒ½ï¼šå°‡å¤šå€‹åœ–å±¤ï¼ˆè¦–é »å±¤ + OSD å±¤ï¼‰å¯¦æ™‚åˆæˆï¼›æ”¯æŒï¼šæœ€å¤š 4 å€‹åœ–å±¤åŒæ™‚ç–ŠåŠ ï¼›åˆ·æ–°ç‡ï¼š60Hzï¼ˆæ¯ç§’åˆ·æ–° 60 æ¬¡ï¼Œç„¡æ’•è£‚ï¼‰<br><br>
2ï¸âƒ£ <b>MIPI DSI æ¥å£</b>ï¼šå…¨ç¨±ï¼šMobile Industry Processor Interface - Display Serial Interfaceï¼›åŠŸèƒ½ï¼šå°‡æ•¸å­—è¦–é »ä¿¡è™Ÿå‚³è¼¸åˆ° LCD å±å¹•ï¼›å¸¶å¯¬ï¼šæœ€é«˜æ”¯æŒ 4K@60fps è¼¸å‡º<br><br>
3ï¸âƒ£ <b>åœ–å±¤åˆæˆéç¨‹</b>ï¼šStep 1ï¼šDisplay VO å¾ Share Memory è®€å–è¦–é »å±¤æ•¸æ“šï¼›Step 2ï¼šå¾ DDR è®€å– OSD å±¤æ•¸æ“šï¼›Step 3ï¼šç¡¬é«”åŸ·è¡Œ Alpha Blendingï¼ˆæ ¹æ“šé€æ˜åº¦æ··åˆé¡è‰²ï¼‰ï¼›Step 4ï¼šåˆæˆçµæœé€šé MIPI DSI ç™¼é€åˆ°å±å¹•<br><br>
4ï¸âƒ£ <b>åƒåœ¾å›æ”¶å„ªåŒ–</b>ï¼š<code>gc.collect()</code>ï¼šè§¸ç™¼ Python åƒåœ¾å›æ”¶å™¨ï¼›ä½œç”¨ï¼šé‡‹æ”¾ä¸å†ä½¿ç”¨çš„è‡¨æ™‚å°è±¡å…§å­˜ï¼›é¿å…å…§å­˜ç¢ç‰‡åŒ–å°è‡´çš„æ€§èƒ½ä¸‹é™
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>show_image() å‡½æ•¸å·¥ä½œåŸç†</b>ï¼šå°‡ OSD åœ–å±¤çš„å…§å­˜åœ°å€å‚³éçµ¦ Display VO å¯„å­˜å™¨ï¼›è§¸ç™¼ç¡¬é«” DMA é–‹å§‹åˆæˆä¸‹ä¸€å¹€ï¼›CPU é–‹éŠ·ï¼šåƒ…å¯«å…¥å¹¾å€‹å¯„å­˜å™¨ï¼ˆ< 1 å¾®ç§’ï¼‰<br><br>
<b>é›™ç·©è¡æ©Ÿåˆ¶</b>ï¼šå‰ç·©è¡ï¼šDisplay VO æ­£åœ¨è®€å–ä¸¦é¡¯ç¤ºçš„å¹€ï¼›å¾Œç·©è¡ï¼šCPU æ­£åœ¨ç¹ªè£½çš„ä¸‹ä¸€å¹€ï¼›å‚ç›´åŒæ­¥ï¼šåœ¨å±å¹•åˆ·æ–°é–“éš™åˆ‡æ›ç·©è¡å€ï¼ˆé¿å…ç•«é¢æ’•è£‚ï¼‰<br><br>
<b>æ€§èƒ½å„ªåŒ–</b>ï¼š<b>é›¶å»¶é²è·¯å¾‘</b>ï¼šè¦–é »å±¤ç›´æ¥å¾ Sensor ç¶å®šï¼Œç„¡è»Ÿé«”å¹²é ï¼›<b>ç•°æ­¥åˆæˆ</b>ï¼šDisplay VO ç¡¬é«”ä¸¦è¡ŒåŸ·è¡Œåˆæˆï¼ŒCPU å¯ç«‹å³è™•ç†ä¸‹ä¸€å¹€ï¼›<b>å¸¶å¯¬å„ªåŒ–</b>ï¼šOSD å±¤åªå‚³è¼¸è®ŠåŒ–çš„å€åŸŸï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
</div>`,
            code: `# ===== é¡¯ç¤º OSD =====
Display.show_image(osd_img)
gc.collect()`,
            targets: ['hw-vo', 'hw-dsi', 'hw-gpu']
        },
        'init': {
            title: '0ï¸âƒ£ æ¨¡å‹åˆå§‹åŒ–',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šAI æ¨¡å‹å’Œé è™•ç†æµæ°´ç·šåˆå§‹åŒ–</b><br><br>
1ï¸âƒ£ <b>AI2D é…ç½®</b>ï¼š<code>set_dtype()</code>ï¼šæŒ‡å®šè¼¸å…¥è¼¸å‡ºçš„æ•¸æ“šæ ¼å¼ï¼ˆNCHWï¼Œuint8ï¼‰ï¼›<code>set_pad_param()</code>ï¼šé…ç½® Padding åƒæ•¸ï¼ˆä½ç½®ã€é¡è‰²ï¼‰ï¼›<code>set_resize_param()</code>ï¼šé…ç½®ç¸®æ”¾æ’å€¼æ–¹æ³•ï¼ˆé›™ç·šæ€§ï¼‰ï¼›<code>build()</code>ï¼šç·¨è­¯ç”Ÿæˆç¡¬é«”æŒ‡ä»¤æµ<br><br>
2ï¸âƒ£ <b>KPU æ¨¡å‹åŠ è¼‰</b>ï¼š<code>load_kmodel()</code>ï¼šå¾ SD/eMMC è®€å–æ¨¡å‹æ–‡ä»¶ï¼›æ–‡ä»¶è·¯å¾‘ï¼š<code>/sdcard/examples/kmodel/yolov8n_224.kmodel</code>ï¼›åŠ è¼‰å…§å®¹ï¼šç¶²çµ¡çµæ§‹ + é‡åŒ–åƒæ•¸ + æ¬Šé‡æ•¸æ“šï¼ˆç´„ 6MBï¼‰<br><br>
3ï¸âƒ£ <b>å…§å­˜é åˆ†é…</b>ï¼šå‰µå»ºè¼¸å…¥ Tensorï¼šå­˜æ”¾ AI2D é è™•ç†å‰çš„åœ–åƒï¼›å‰µå»ºè¼¸å‡º Tensorï¼šå­˜æ”¾ AI2D é è™•ç†å¾Œçš„åœ–åƒï¼›ä½œç”¨ï¼šé¿å…é‹è¡Œæ™‚å‹•æ…‹åˆ†é…å…§å­˜ï¼ˆæ¸›å°‘å»¶é²æŠ–å‹•ï¼‰
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>NCHW æ ¼å¼</b>ï¼šN (Batch)ï¼šæ‰¹æ¬¡å¤§å°ï¼ˆé€™è£¡æ˜¯ 1ï¼‰ï¼›C (Channel)ï¼šé€šé“æ•¸ï¼ˆRGB ä¸‰é€šé“ï¼‰ï¼›H (Height)ï¼šåœ–åƒé«˜åº¦ï¼›W (Width)ï¼šåœ–åƒå¯¬åº¦ï¼›å…§å­˜å¸ƒå±€ï¼š[R0R1R2...][G0G1G2...][B0B1B2...]ï¼ˆé€šé“é€£çºŒï¼‰<br><br>
<b>é›™ç·šæ€§æ’å€¼</b>ï¼ˆtf_bilinearï¼‰ï¼šè¨ˆç®—æ–°åƒç´ å€¼ = å‘¨åœ 4 å€‹åƒç´ çš„åŠ æ¬Šå¹³å‡ï¼›æ¬Šé‡æ ¹æ“šè·é›¢è¨ˆç®—ï¼ˆè·é›¢è¶Šè¿‘æ¬Šé‡è¶Šå¤§ï¼‰ï¼›æ•ˆæœï¼šç¸®æ”¾å¾Œçš„åœ–åƒæ›´å¹³æ»‘ï¼Œç„¡é‹¸é½’<br><br>
<b>half_pixel å°é½Šæ¨¡å¼</b>ï¼šåº§æ¨™æ˜ å°„å…¬å¼ï¼š<code>src_x = (dst_x + 0.5) Ã— scale - 0.5</code>ï¼›ä½œç”¨ï¼šç¢ºä¿ç¸®æ”¾å¾Œçš„åœ–åƒä¸­å¿ƒå°é½ŠåŸåœ–ï¼›èˆ‡ TensorFlow é è™•ç†ä¸€è‡´ï¼ˆä¿è­‰æ¨¡å‹æº–ç¢ºç‡ï¼‰
</div>`,
            code: `# ---------- 1. åˆå§‹åŒ– AI2D é è™•ç† ----------
print("[2/7] åˆå§‹åŒ– AI2D é è™•ç†...")
ai2d = nn.ai2d()
ai2d.set_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)

# è¨ˆç®— letterbox åƒæ•¸
top, bottom, left, right, ratio = letterbox_pad_param([AI_RGB888P_WIDTH, AI_RGB888P_HEIGHT], model_input_size)
ai2d.set_pad_param(True, [0,0,0,0,top,bottom,left,right], 0, [128,128,128])
ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)

# æ§‹å»º AI2D æµç¨‹
ai2d_builder = ai2d.build([1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH], [1,3,model_input_size[1],model_input_size[0]])
print("âœ“ AI2D é è™•ç†é…ç½®å®Œæˆ")

# ---------- 2. åˆå§‹åŒ– KPU æ¨¡å‹ ----------
print("[3/7] åŠ è¼‰ YOLOv8 æ¨¡å‹...")
kpu = nn.kpu()
kpu.load_kmodel(kmodel_path)
print("âœ“ æ¨¡å‹åŠ è¼‰æˆåŠŸ")

# æº–å‚™è¼¸å…¥è¼¸å‡º tensor
ai2d_input_tensor = nn.from_numpy(np.zeros((1,3,AI_RGB888P_HEIGHT,AI_RGB888P_WIDTH), dtype=np.uint8))
kpu_input_tensor = nn.from_numpy(np.zeros((1,3,model_input_size[1],model_input_size[0]), dtype=np.uint8))`,
            targets: ['hw-highspeed', 'hw-ddr', 'hw-cpu1', 'hw-ai2d', 'hw-kpu']
        },
        'config': {
            title: '1ï¸âƒ£ Letterbox åƒæ•¸è¨ˆç®—',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šä¿æŒå¯¬é«˜æ¯”çš„åœ–åƒç¸®æ”¾</b><br><br>
1ï¸âƒ£ <b>ç‚ºä»€éº¼éœ€è¦ Letterboxï¼Ÿ</b>æ”åƒé ­è¼¸å‡ºï¼š1280Ã—720ï¼ˆå¯¬é«˜æ¯” 16:9ï¼‰ï¼›æ¨¡å‹è¼¸å…¥è¦æ±‚ï¼š224Ã—224ï¼ˆå¯¬é«˜æ¯” 1:1ï¼‰ï¼›ç›´æ¥æ‹‰ä¼¸è®Šå½¢ â†’ æ±½è»Šè®Šæˆæ–¹å½¢ â†’ æª¢æ¸¬æº–ç¢ºç‡ä¸‹é™ 10-20%ï¼›Letterbox ä¿æŒæ¯”ä¾‹ â†’ ç‰©é«”å½¢ç‹€ä¸è®Š â†’ æº–ç¢ºç‡ä¸ä¸‹é™<br><br>
2ï¸âƒ£ <b>è¨ˆç®—æ­¥é©Ÿ</b>ï¼šè¨ˆç®—å¯¬é«˜ç¸®æ”¾æ¯”ä¾‹ï¼š<code>ratio = min(224/1280, 224/720) â‰ˆ 0.175</code>ï¼›é¸æ“‡è¼ƒå°çš„æ¯”ä¾‹ï¼ˆé¿å…è£åˆ‡åœ–åƒå…§å®¹ï¼‰ï¼›ç¸®æ”¾å¾Œå°ºå¯¸ï¼š224Ã—126ï¼ˆä¿æŒ 16:9 æ¯”ä¾‹ï¼‰ï¼›è¨ˆç®— Paddingï¼š<code>(224-126)/2 = 49</code> åƒç´ ï¼ˆä¸Šä¸‹å„å¡«å……ï¼‰<br><br>
3ï¸âƒ£ <b>Padding é¡è‰²é¸æ“‡</b>ï¼šä½¿ç”¨ä¸­æ€§ç° [128, 128, 128]ï¼ˆRGB ä¸‰é€šé“ç›¸åŒï¼‰ï¼›åŸå› ï¼šç°è‰²ä¸æœƒè¢«èª¤èªç‚ºç‰©é«”ç‰¹å¾µï¼›å¦‚æœç”¨é»‘è‰² [0,0,0] æˆ–ç™½è‰² [255,255,255] å¯èƒ½å¹²æ“¾é‚Šç·£æª¢æ¸¬
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>å…·é«”è¨ˆç®—ç¤ºä¾‹</b>ï¼šratio_w = 224 / 1280 = 0.175ï¼›ratio_h = 224 / 720 = 0.311ï¼›ratio = min(0.175, 0.311) = 0.175ï¼›new_w = 1280 Ã— 0.175 = 224ï¼›new_h = 720 Ã— 0.175 = 126ï¼›dh = (224 - 126) / 2 = 49ï¼›top = 0ï¼Œbottom = 98ï¼Œleft = 0ï¼Œright = 0<br><br>
<b>è¿”å›å€¼èªªæ˜</b>ï¼š<code>top, bottom, left, right</code>ï¼šå››å€‹æ–¹å‘çš„ Padding åƒç´ æ•¸ï¼›<code>ratio</code>ï¼šç¸®æ”¾æ¯”ä¾‹ï¼ˆå¾ŒçºŒåæ¨™è½‰æ›æ™‚éœ€è¦ç”¨åˆ°ï¼‰<br><br>
<b>å°ç¨± Padding</b>ï¼šä¸Šä¸‹å¡«å……ï¼š0 + 98 = 98 åƒç´ ï¼ˆä¸å°ç¨±ä½†ç¸½å’Œæ­£ç¢ºï¼‰ï¼›åŸå› ï¼šä»£ç¢¼ä¸­ <code>top=0</code>ï¼Œæ‰€æœ‰ Padding æ”¾åœ¨åº•éƒ¨ï¼›å¯¦éš›æ•ˆæœï¼šåœ–åƒé ä¸Šå°é½Šï¼Œåº•éƒ¨ç•™ç°è‰²é‚Šæ¡†
</div>`,
            code: `# ==================== 1. Letterbox åƒæ•¸è¨ˆç®— ====================
def letterbox_pad_param(input_size, output_size):
    """è¨ˆç®—ä¿æŒå¯¬é«˜æ¯”çš„ç¸®æ”¾å’Œ padding åƒæ•¸"""
    ratio_w = output_size[0] / input_size[0]
    ratio_h = output_size[1] / input_size[1]
    ratio = min(ratio_w, ratio_h)
    new_w = int(ratio * input_size[0])
    new_h = int(ratio * input_size[1])
    dw = (output_size[0] - new_w) / 2
    dh = (output_size[1] - new_h) / 2
    top = int(round(0))
    bottom = int(round(dh * 2 + 0.1))
    left = int(round(0))
    right = int(round(dw * 2 - 0.1))
    return top, bottom, left, right, ratio`,
            targets: ['hw-cpu1']
        },
        'preprocess': {
            title: '2ï¸âƒ£ AI2D ç¡¬é«”é è™•ç†',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šç¡¬é«”åŠ é€Ÿåœ–åƒé è™•ç†</b><br><br>
1ï¸âƒ£ <b>AI2D åŸ·è¡Œçš„æ“ä½œ</b>ï¼š<b>Resize</b>ï¼š1280Ã—720 â†’ 224Ã—224ï¼ˆé›™ç·šæ€§æ’å€¼ï¼‰ï¼›<b>Padding</b>ï¼šå¡«å……ç°è‰²é‚Šæ¡†ï¼ˆä¸Šä¸‹å„ 49 åƒç´ ï¼‰ï¼›<b>æ ¼å¼ä¿æŒ</b>ï¼šRGB888P â†’ RGB888Pï¼ˆç„¡è½‰æ›é–‹éŠ·ï¼‰<br><br>
2ï¸âƒ£ <b>æ€§èƒ½å°æ¯”</b>ï¼š<b>CPU è»Ÿé«”è™•ç†</b>ï¼ˆOpenCV resizeï¼‰ï¼šç´„ 50ms/å¹€ï¼›<b>AI2D ç¡¬é«”è™•ç†</b>ï¼šç´„ 2ms/å¹€ï¼›<b>åŠ é€Ÿæ¯”</b>ï¼š25 å€ï¼›åŸå› ï¼šå°ˆç”¨ç¡¬é«”é›»è·¯ä¸¦è¡Œè™•ç†ï¼Œç„¡æŒ‡ä»¤è§£ç¢¼é–‹éŠ·<br><br>
3ï¸âƒ£ <b>æ•¸æ“šæµè·¯å¾‘</b>ï¼šè¼¸å…¥ï¼šShare Memoryï¼ˆ1280Ã—720 RGB åœ–åƒï¼‰ï¼›è™•ç†ï¼šAI2D å¼•æ“ï¼ˆç¡¬é«”ï¼‰ï¼›è¼¸å‡ºï¼šAI SRAMï¼ˆ224Ã—224 RGB åœ–åƒï¼‰ï¼›ä¸‹ä¸€æ­¥ï¼šKPU ç›´æ¥å¾ SRAM è®€å–ï¼ˆç„¡éœ€å†è¨ªå• DDRï¼‰
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>run() æ–¹æ³•åŸ·è¡Œéç¨‹</b>ï¼š1. å°‡è¼¸å…¥ Tensor çš„å…§å­˜åœ°å€å¯«å…¥ AI2D å¯„å­˜å™¨ï¼›2. è§¸ç™¼ AI2D å•Ÿå‹•ï¼ˆå¯«å…¥å•Ÿå‹•ä½ï¼‰ï¼›3. AI2D ç¡¬é«”è®€å– Share Memory æ•¸æ“šï¼›4. åŸ·è¡Œ Resize + Padding æµæ°´ç·šï¼›5. å°‡çµæœå¯«å…¥ AI SRAMï¼›6. å®Œæˆå¾Œè§¸ç™¼ä¸­æ–·é€šçŸ¥ CPU<br><br>
<b>é›™ç·šæ€§æ’å€¼ç¡¬é«”å¯¦ç¾</b>ï¼šæ¯å€‹è¼¸å‡ºåƒç´ éœ€è¦ 4 æ¬¡ä¹˜æ³• + 3 æ¬¡åŠ æ³•ï¼›224Ã—224 = 50,176 å€‹åƒç´  â†’ ç´„ 20 è¬æ¬¡é‹ç®—ï¼›AI2D æ“æœ‰ 16 å€‹ä¸¦è¡Œæ’å€¼å–®å…ƒï¼›è™•ç†æ™‚é–“ï¼š50,176 Ã· 16 Ã· 400MHz â‰ˆ 0.8ms<br><br>
<b>å…§å­˜å¸¶å¯¬éœ€æ±‚</b>ï¼šè®€å–ï¼š1280Ã—720Ã—3 = 2.76MBï¼›å¯«å…¥ï¼š224Ã—224Ã—3 = 0.15MBï¼›ç¸½å¸¶å¯¬ï¼š2.91MB Ã· 2ms = 1455 MB/sï¼›K230 DDR å¸¶å¯¬ï¼š3200 MB/sï¼ˆè¶³å¤ ï¼‰
</div>`,
            code: `# ===== AI2D é è™•ç† =====
ai2d_builder.run(ai2d_input_tensor, kpu_input_tensor)`,
            targets: ['hw-ai2d', 'hw-ai-sram', 'hw-share']
        },
        'inference': {
            title: '3ï¸âƒ£ KPU ç¥ç¶“ç¶²çµ¡æ¨ç†',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šYOLOv8 ç›®æ¨™æª¢æ¸¬æ¨ç†</b><br><br>
1ï¸âƒ£ <b>KPU æ¨ç†éç¨‹</b>ï¼šè¼¸å…¥ï¼š224Ã—224Ã—3 RGB åœ–åƒï¼ˆ150KBï¼‰ï¼›åŸ·è¡Œï¼š80 å±¤ç¥ç¶“ç¶²çµ¡ï¼ˆå·ç©ã€æ± åŒ–ã€æ¿€æ´»å‡½æ•¸ï¼‰ï¼›è¼¸å‡ºï¼š3 å€‹å°ºåº¦çš„ç‰¹å¾µåœ–ï¼ˆåŒ…å«ä½ç½®å’Œé¡åˆ¥ä¿¡æ¯ï¼‰ï¼›è€—æ™‚ï¼šç´„ 15ms/å¹€ï¼ˆYOLOv8-n æ¨¡å‹ï¼‰<br><br>
2ï¸âƒ£ <b>INT8 é‡åŒ–æŠ€è¡“</b>ï¼šFP32 æ¨¡å‹ï¼šæ¯å€‹æ¬Šé‡ 4 å­—ç¯€ â†’ 24MBï¼›INT8 æ¨¡å‹ï¼šæ¯å€‹æ¬Šé‡ 1 å­—ç¯€ â†’ 6MBï¼ˆç¯€çœ 75% å­˜å„²ï¼‰ï¼›ç²¾åº¦æå¤±ï¼š<1%ï¼ˆå¹¾ä¹ç„¡å½±éŸ¿ï¼‰ï¼›é€Ÿåº¦æå‡ï¼š4 å€ï¼ˆINT8 ä¹˜æ³•å™¨æ¯” FP32 å¿«ï¼‰<br><br>
3ï¸âƒ£ <b>3 TOPS ç®—åŠ›çš„å«ç¾©</b>ï¼šTOPS = Tera Operations Per Secondï¼ˆè¬å„„æ¬¡/ç§’ï¼‰ï¼›3 TOPS = æ¯ç§’åŸ·è¡Œ 3 è¬å„„æ¬¡ INT8 ä¹˜åŠ é‹ç®—ï¼›YOLOv8-n æ¯å¹€ç´„éœ€ 450 å„„æ¬¡é‹ç®—ï¼›ç†è«–æ¨ç†æ™‚é–“ï¼š45G Ã· 3T = 15ms
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>set_input_tensor() æ–¹æ³•</b>ï¼šåƒæ•¸ 0ï¼šè¼¸å…¥ç´¢å¼•ï¼ˆYOLOv8 åªæœ‰ä¸€å€‹è¼¸å…¥ï¼‰ï¼›ä½œç”¨ï¼šå°‡ AI SRAM ä¸­çš„æ•¸æ“šåœ°å€ç¶å®šåˆ° KPU è¼¸å…¥ï¼›ç„¡æ•¸æ“šè¤‡è£½ï¼šç›´æ¥å‚³éå…§å­˜æŒ‡é‡<br><br>
<b>kpu.run() åŸ·è¡Œæµç¨‹</b>ï¼š1. å¾ AI SRAM è®€å–è¼¸å…¥æ•¸æ“šï¼›2. åŸ·è¡Œç¬¬ 1 å±¤å·ç©ï¼ˆ3Ã—3 å·ç©æ ¸ï¼‰ï¼›3. åŸ·è¡Œ ReLU æ¿€æ´»å‡½æ•¸ï¼›4. ... é‡è¤‡ 80 å±¤ ...ï¼›5. ç”Ÿæˆ 3 å€‹å°ºåº¦çš„è¼¸å‡ºç‰¹å¾µåœ–ï¼›6. å°‡çµæœå¯«å…¥ DDR<br><br>
<b>è¼¸å‡ºçµæœæ ¼å¼</b>ï¼šè¼¸å‡º 1ï¼š[1, 25200, 35]ï¼ˆå¤§ç‰©é«”æª¢æ¸¬ï¼‰ï¼›25200 = 84Ã—84 ç¶²æ ¼Ã—3 å€‹éŒ¨æ¡†ï¼›35 = [x, y, w, h] + 30 å€‹é¡åˆ¥åˆ†æ•¸ + ç½®ä¿¡åº¦<br><br>
<b>å¤šå°ºåº¦æª¢æ¸¬åŸç†</b>ï¼šå¤§ç¶²æ ¼ï¼ˆ7Ã—7ï¼‰ï¼šæª¢æ¸¬å¤§ç‰©é«”ï¼ˆæ±½è»Šã€å¡è»Šï¼‰ï¼›ä¸­ç¶²æ ¼ï¼ˆ14Ã—14ï¼‰ï¼šæª¢æ¸¬ä¸­ç­‰ç‰©é«”ï¼ˆäººï¼‰ï¼›å°ç¶²æ ¼ï¼ˆ28Ã—28ï¼‰ï¼šæª¢æ¸¬å°ç‰©é«”ï¼ˆäº¤é€šæ¨™èªŒï¼‰
</div>`,
            code: `# ===== KPU æ¨ç† =====
kpu.set_input_tensor(0, kpu_input_tensor)
kpu.run()

# ===== ç²å–æ¨ç†çµæœ =====
results = []
for i in range(kpu.outputs_size()):
    output_tensor = kpu.get_output_tensor(i)
    result = output_tensor.to_numpy()
    results.append(result)`,
            targets: ['hw-kpu', 'hw-ai-sram', 'hw-ddr']
        },
        'postprocess': {
            title: '4ï¸âƒ£ è¼¸å‡ºè§£æèˆ‡ç¯©é¸',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šè§£æç¥ç¶“ç¶²çµ¡è¼¸å‡ºä¸¦ç¯©é¸æœ‰æ•ˆæª¢æ¸¬</b><br><br>
1ï¸âƒ£ <b>æ•¸æ“šè½‰ç½®</b>ï¼šKPU è¼¸å‡ºæ ¼å¼ï¼š[1, 25200, 35]ï¼›è½‰ç½®å¾Œï¼š[25200, 35]ï¼ˆæ–¹ä¾¿å¾ŒçºŒè™•ç†ï¼‰ï¼›æ¯è¡Œä»£è¡¨ä¸€å€‹å€™é¸æª¢æ¸¬æ¡†<br><br>
2ï¸âƒ£ <b>æ•¸æ“šåˆ†é›¢</b>ï¼š<code>boxes_ori</code>ï¼šå‰ 4 åˆ— [x, y, w, h]ï¼ˆé‚Šç•Œæ¡†åæ¨™ï¼‰ï¼›<code>class_ori</code>ï¼šå¾Œ 30 åˆ—ï¼ˆ30 å€‹é¡åˆ¥çš„åˆ†æ•¸ï¼‰ï¼›<code>argmax()</code>ï¼šæ‰¾å‡ºåˆ†æ•¸æœ€é«˜çš„é¡åˆ¥ï¼›<code>max()</code>ï¼šè©²é¡åˆ¥çš„ç½®ä¿¡åº¦åˆ†æ•¸<br><br>
3ï¸âƒ£ <b>ç½®ä¿¡åº¦ç¯©é¸</b>ï¼šé–¾å€¼ï¼š0.3ï¼ˆ30% ç½®ä¿¡åº¦ï¼‰ï¼›ç¯©é¸å‰ï¼šç´„ 25,200 å€‹å€™é¸æ¡†ï¼›ç¯©é¸å¾Œï¼šç´„ 50-200 å€‹å€™é¸æ¡†ï¼›ä½œç”¨ï¼šæ¸›å°‘èª¤æª¢ï¼ˆå¦‚å°‡æ¨¹è‘‰èª¤èªç‚ºé³¥ï¼‰<br><br>
4ï¸âƒ£ <b>åæ¨™è½‰æ›</b>ï¼šä¸­å¿ƒé»æ ¼å¼ (x, y, w, h) â†’ å·¦ä¸Šå³ä¸‹æ ¼å¼ (x1, y1, x2, y2)ï¼›å¾æ¨¡å‹ç©ºé–“ï¼ˆ224Ã—224ï¼‰â†’ åŸåœ–ç©ºé–“ï¼ˆ1280Ã—720ï¼‰ï¼›å…¬å¼ï¼š<code>x1 = (x - w/2) / ratio</code>
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>transpose() æ“ä½œ</b>ï¼šåŸå§‹ï¼š[1, 25200, 35] â†’ 3D å¼µé‡ï¼›è½‰ç½®ï¼š[25200, 35] â†’ 2D çŸ©é™£ï¼ˆä¸Ÿæ£„æ‰¹æ¬¡ç¶­åº¦ï¼‰ï¼›å…§å­˜å¸ƒå±€è®ŠåŒ–ï¼šè¡Œå„ªå…ˆ â†” åˆ—å„ªå…ˆ<br><br>
<b>argmax() å’Œ max() ç¤ºä¾‹</b>ï¼šclass_scores = [0.1, 0.8, 0.05, 0.03, ...]ï¼›argmax() â†’ 1ï¼ˆç¬¬ 1 é¡ bicycleï¼‰ï¼›max() â†’ 0.8ï¼ˆç½®ä¿¡åº¦ 80%ï¼‰<br><br>
<b>åæ¨™è½‰æ›å…¬å¼</b>ï¼šx1 = (x - 0.5 Ã— w) / ratioï¼›y1 = (y - 0.5 Ã— h) / ratioï¼›x2 = (x + 0.5 Ã— w) / ratioï¼›y2 = (y + 0.5 Ã— h) / ratio<br><br>
<b>ratio çš„ä½œç”¨</b>ï¼šé è™•ç†æ™‚ç¸®å°äº† ratio å€ï¼ˆ0.175ï¼‰ï¼›ç¾åœ¨éœ€è¦æ”¾å¤§ 1/ratio å€é‚„åŸåˆ°åŸåœ–ï¼›ä¾‹å¦‚ï¼šæ¨¡å‹è¼¸å‡º x=100 â†’ åŸåœ– x=100/0.175â‰ˆ571
</div>`,
            code: `# ===== å¾Œè™•ç†ï¼šè§£æè¼¸å‡º =====
output_data = results[0][0].transpose()
boxes_ori = output_data[:, 0:4]
class_ori = output_data[:, 4:]
class_res = np.argmax(class_ori, axis=-1)
scores_ = np.max(class_ori, axis=-1)

# ===== ç¯©é¸èˆ‡åæ¨™è½‰æ› =====
boxes, inds, scores = [], [], []
for i in range(len(boxes_ori)):
    if scores_[i] > confidence_threshold:
        x, y, w, h = boxes_ori[i]
        x1 = int((x - 0.5 * w) / ratio)
        y1 = int((y - 0.5 * h) / ratio)
        x2 = int((x + 0.5 * w) / ratio)
        y2 = int((y + 0.5 * h) / ratio)
        boxes.append([x1, y1, x2, y2])
        inds.append(class_res[i])
        scores.append(scores_[i])`,
            targets: ['hw-cpu1', 'hw-ddr']
        },
        'nms': {
            title: '5ï¸âƒ£ NMS éæ¥µå¤§å€¼æŠ‘åˆ¶ + åæ¨™æ•´ç†',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šå»é™¤é‡ç–Šçš„å†—ä½™æª¢æ¸¬æ¡†ä¸¦æ•´ç†æœ€çµ‚çµæœ</b><br><br>
1ï¸âƒ£ <b>ç‚ºä»€éº¼éœ€è¦ NMSï¼Ÿ</b>åŒä¸€å€‹ç‰©é«”å¯èƒ½è¢«æª¢æ¸¬å¤šæ¬¡ï¼ˆä¸åŒä½ç½®ã€ä¸åŒå°ºåº¦çš„éŒ¨æ¡†ï¼‰ï¼›ä¾‹å¦‚ï¼šä¸€è¼›æ±½è»Šå¯èƒ½æœ‰ 5 å€‹æª¢æ¸¬æ¡†ï¼Œç½®ä¿¡åº¦åˆ†åˆ¥ç‚º 0.9ã€0.85ã€0.8ã€0.75ã€0.7ï¼›NMS åªä¿ç•™ç½®ä¿¡åº¦æœ€é«˜çš„æ¡†ï¼ˆ0.9ï¼‰ï¼ŒæŠ‘åˆ¶å…¶ä»– 4 å€‹<br><br>
2ï¸âƒ£ <b>IoUï¼ˆäº¤ä¸¦æ¯”ï¼‰è¨ˆç®—</b>ï¼šIoU = äº¤é›†é¢ç© Ã· ä¸¦é›†é¢ç©ï¼›IoU = 0ï¼šå…©å€‹æ¡†å®Œå…¨ä¸é‡ç–Šï¼›IoU = 1ï¼šå…©å€‹æ¡†å®Œå…¨é‡ç–Šï¼›IoU > 0.4ï¼šèªç‚ºæ˜¯åŒä¸€å€‹ç‰©é«”çš„é‡è¤‡æª¢æ¸¬<br><br>
3ï¸âƒ£ <b>NMS ç®—æ³•æ­¥é©Ÿ</b>ï¼šæŒ‰ç½®ä¿¡åº¦é™åºæ’åºæ‰€æœ‰æª¢æ¸¬æ¡†ï¼›é¸æ“‡ç½®ä¿¡åº¦æœ€é«˜çš„æ¡† Aï¼ŒåŠ å…¥çµæœåˆ—è¡¨ï¼›è¨ˆç®—å…¶ä»–æ¡†èˆ‡ A çš„ IoUï¼›åˆªé™¤ IoU > 0.4 çš„æ¡†ï¼ˆèªç‚ºæ˜¯é‡è¤‡ï¼‰ï¼›é‡è¤‡ä¸Šè¿°æ­¥é©Ÿï¼Œç›´åˆ°è™•ç†å®Œæ‰€æœ‰æ¡†<br><br>
4ï¸âƒ£ <b>åæ¨™æ•´ç†</b>ï¼šå°‡ boxesï¼ˆåæ¨™ï¼‰ã€scoresï¼ˆç½®ä¿¡åº¦ï¼‰ã€indsï¼ˆé¡åˆ¥ IDï¼‰åˆä½µæˆçµ±ä¸€æ•¸çµ„ï¼›æ ¼å¼ï¼š[[x1, y1, x2, y2, score, class_id], ...]ï¼›é™åˆ¶æœ€å¤š 50 å€‹æª¢æ¸¬æ¡†ï¼ˆé¿å…ç•«é¢æ··äº‚ï¼‰
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>IoU è¨ˆç®—å…¬å¼</b>ï¼šxx1 = max(box1_x1, box2_x1)ï¼›yy1 = max(box1_y1, box2_y1)ï¼›xx2 = min(box1_x2, box2_x2)ï¼›yy2 = min(box1_y2, box2_y2)ï¼›inter = max(0, xx2 - xx1) Ã— max(0, yy2 - yy1)ï¼›union = area1 + area2 - interï¼›iou = inter / union<br><br>
<b>å‘é‡åŒ–åŠ é€Ÿç¤ºä¾‹</b>ï¼šæ…¢é€Ÿç‰ˆæœ¬ï¼ˆPython å¾ªç’°ï¼‰ï¼šfor i in range(len(boxes)): xx1 = max(x1[0], x1[i])ï¼›å¿«é€Ÿç‰ˆæœ¬ï¼ˆNumPy å‘é‡åŒ–ï¼‰ï¼šxx1 = np.maximum(x1[0], x1[1:])ï¼ˆä¸€æ¬¡æ€§è¨ˆç®—æ‰€æœ‰ï¼‰<br><br>
<b>RVV1.0 å‘é‡æŒ‡ä»¤</b>ï¼šä¸€æ¢æŒ‡ä»¤åŒæ™‚è™•ç† 8 å€‹æµ®é»æ•¸ï¼ˆSIMDï¼‰ï¼›<code>np.maximum()</code> è‡ªå‹•ç·¨è­¯ç‚ºå‘é‡æŒ‡ä»¤ï¼›ç†è«–åŠ é€Ÿæ¯”ï¼š8 å€<br><br>
<b>concatenate() æ“ä½œ</b>ï¼šboxesï¼š[N, 4] æ•¸çµ„ï¼›scoresï¼š[N] â†’ reshape æˆ [N, 1]ï¼›indsï¼š[N] â†’ reshape æˆ [N, 1]ï¼›åˆä½µçµæœï¼š[N, 6] æ•¸çµ„
</div>`,
            code: `# ===== NMS å»é‡ =====
if len(boxes) > 0:
    boxes = np.array(boxes)
    scores = np.array(scores)
    keep = nms(boxes, scores, nms_threshold)
    
    dets = np.concatenate((boxes, scores.reshape((len(boxes), 1)), inds.reshape((len(boxes), 1))), axis=1)
    det_res = [dets[i] for i in keep]
    det_res = np.array(det_res)[:max_boxes_num, :]
else:
    det_res = np.array([])`,
            targets: ['hw-cpu1']
        },
        'coord': {
            title: '6ï¸âƒ£ åæ¨™æ•´ç†ï¼ˆå·²æ•´åˆè‡³ NMSï¼‰',
            text: `
<div class="key-point">
<b>âš ï¸ æ³¨æ„ï¼šåæ¨™æ•´ç†å·²æ•´åˆåˆ° NMS æ­¥é©Ÿä¸­</b><br><br>
<b>ç‚ºä»€éº¼åˆä½µé€™å…©å€‹æ­¥é©Ÿï¼Ÿ</b><br>
1ï¸âƒ£ <b>æµç¨‹é€£è²«æ€§</b>ï¼šNMS éœ€è¦å…ˆç¯©é¸æª¢æ¸¬æ¡†ï¼Œç„¶å¾Œç«‹å³æ•´ç†åæ¨™æ•¸æ“šï¼›åˆ†é–‹åŸ·è¡Œæœƒå¢åŠ ä¸å¿…è¦çš„ä¸­é–“è®Šé‡å’Œå…§å­˜è¨ªå•<br><br>
2ï¸âƒ£ <b>æ€§èƒ½å„ªåŒ–</b>ï¼šåˆä½µå¾Œåªéœ€ä¸€æ¬¡ NumPy æ•¸çµ„æ“ä½œï¼ˆconcatenateï¼‰ï¼›é¿å…é‡è¤‡éæ­·æª¢æ¸¬æ¡†åˆ—è¡¨<br><br>
3ï¸âƒ£ <b>ä»£ç¢¼ç°¡æ½”</b>ï¼šå°‡é‚è¼¯ç›¸é—œçš„æ“ä½œæ”¾åœ¨ä¸€èµ·ï¼Œæ›´æ˜“ç†è§£å’Œç¶­è­·<br><br>
<b>å¯¦éš›åŸ·è¡Œå…§å®¹</b>ï¼ˆåœ¨ NMS æ­¥é©Ÿä¸­ï¼‰ï¼š<br>
â€¢ ä½¿ç”¨ <code>np.concatenate()</code> åˆä½µåæ¨™ã€ç½®ä¿¡åº¦ã€é¡åˆ¥ ID<br>
â€¢ æ ¹æ“š NMS ä¿ç•™çš„ç´¢å¼•æå–æœ€çµ‚çµæœ<br>
â€¢ é™åˆ¶æœ€å¤š 50 å€‹æª¢æ¸¬æ¡†ï¼ˆmax_boxes_numï¼‰
</div>
<div class="tech-spec">
<b>âš¡ æ•¸æ“šæµç¨‹èªªæ˜</b><br><br>
<b>è¼¸å…¥æ•¸æ“š</b>ï¼šboxesï¼š[N, 4] åæ¨™æ•¸çµ„ï¼›scoresï¼š[N] ç½®ä¿¡åº¦æ•¸çµ„ï¼›indsï¼š[N] é¡åˆ¥ ID æ•¸çµ„ï¼›keepï¼šNMS ä¿ç•™çš„ç´¢å¼•åˆ—è¡¨<br><br>
<b>åˆä½µæ“ä½œ</b>ï¼š<code>dets = np.concatenate((boxes, scores.reshape((N,1)), inds.reshape((N,1))), axis=1)</code>ï¼›çµæœï¼š[N, 6] æ•¸çµ„ï¼Œæ¯è¡Œ [x1, y1, x2, y2, score, class_id]<br><br>
<b>æœ€çµ‚è¼¸å‡º</b>ï¼š<code>det_res = [dets[i] for i in keep][:max_boxes_num]</code>ï¼›åªä¿ç•™ NMS ç¯©é¸å¾Œçš„å‰ 50 å€‹æª¢æ¸¬æ¡†ï¼›å…§å­˜é–‹éŠ·ï¼š50 Ã— 6 Ã— 8 å­—ç¯€ = 2400 å­—ç¯€ï¼ˆæ¥µå°ï¼‰
</div>`,
            code: `# ===== NMS å»é‡èˆ‡åæ¨™æ•´ç† =====
if len(boxes) > 0:
    boxes = np.array(boxes)
    scores = np.array(scores)
    keep = nms(boxes, scores, nms_threshold)
    
    # åˆä½µåæ¨™ã€åˆ†æ•¸ã€é¡åˆ¥ ID
    dets = np.concatenate((boxes, scores.reshape((len(boxes), 1)), inds.reshape((len(boxes), 1))), axis=1)
    det_res = [dets[i] for i in keep]
    det_res = np.array(det_res)[:max_boxes_num, :]
else:
    det_res = np.array([])`,
            targets: ['hw-cpu1', 'hw-ddr']
        },
        'draw': {
            title: '7ï¸âƒ£ ç¹ªè£½æª¢æ¸¬çµæœ',
            text: `
<div class="key-point">
<b>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ï¼šåœ¨ OSD å±¤ç¹ªè£½æª¢æ¸¬æ¡†å’Œæ¨™ç±¤</b><br><br>
1ï¸âƒ£ <b>ç¹ªåœ–æ­¥é©Ÿ</b>ï¼š<code>osd_img.clear()</code>ï¼šæ¸…ç©ºä¸Šä¸€å¹€çš„ç¹ªåœ–å…§å®¹ï¼›éæ­·æ¯å€‹æª¢æ¸¬çµæœï¼›è½‰æ›åæ¨™ï¼šAI ç©ºé–“ï¼ˆ1280Ã—720ï¼‰â†’ é¡¯ç¤ºç©ºé–“ï¼ˆ1920Ã—1080ï¼‰ï¼›<code>draw_rectangle()</code>ï¼šç¹ªè£½çŸ©å½¢æ¡†ï¼›<code>draw_string_advanced()</code>ï¼šç¹ªè£½æ–‡å­—æ¨™ç±¤<br><br>
2ï¸âƒ£ <b>é¡è‰²ç·¨ç¢¼</b>ï¼š10 ç¨®é å®šç¾©é¡è‰²ï¼ˆRGB å…ƒçµ„ï¼‰ï¼›æ ¹æ“šé¡åˆ¥ ID å¾ªç’°ä½¿ç”¨ï¼š<code>colors[class_id % 10]</code>ï¼›ä¾‹å¦‚ï¼šé¡åˆ¥ 0ï¼ˆäººï¼‰â†’ ç´…è‰²ï¼Œé¡åˆ¥ 1ï¼ˆè‡ªè¡Œè»Šï¼‰â†’ ç¶ è‰²<br><br>
3ï¸âƒ£ <b>æ–‡å­—æ¨™ç±¤æ ¼å¼</b>ï¼šæ ¼å¼ï¼š<code>"é¡åˆ¥åç¨± ç½®ä¿¡åº¦"</code>ï¼›ä¾‹å¦‚ï¼š<code>"car 0.85"</code>ã€<code>"person 0.92"</code>ï¼›ä½ç½®ï¼šçŸ©å½¢æ¡†ä¸Šæ–¹ 50 åƒç´ ï¼ˆé¿å…é®æ“‹ç‰©é«”ï¼‰<br><br>
4ï¸âƒ£ <b>ç¡¬é«”åŠ é€Ÿ</b>ï¼š<code>draw_rectangle()</code>ï¼šå¯èƒ½ä½¿ç”¨ 2D GDMA å¡«å……åƒç´ ï¼›<code>draw_string_advanced()</code>ï¼šå¯èƒ½ä½¿ç”¨ GPU 2.5D æ¸²æŸ“å­—é«”
</div>
<div class="tech-spec">
<b>âš¡ æŠ€è¡“ç´°ç¯€</b><br><br>
<b>åæ¨™è½‰æ›å…¬å¼</b>ï¼šdraw_x = int(x1 Ã— 1920 Ã· 1280) = int(x1 Ã— 1.5)ï¼›draw_y = int(y1 Ã— 1080 Ã· 720) = int(y1 Ã— 1.5)ï¼›draw_w = int((x2 - x1) Ã— 1.5)ï¼›draw_h = int((y2 - y1) Ã— 1.5)ï¼›æ•´æ•¸é™¤æ³• // ç¢ºä¿åæ¨™ç‚ºæ•´æ•¸<br><br>
<b>draw_rectangle() åƒæ•¸</b>ï¼š(x, y)ï¼šå·¦ä¸Šè§’åæ¨™ï¼›(w, h)ï¼šå¯¬åº¦å’Œé«˜åº¦ï¼›colorï¼šRGB å…ƒçµ„ï¼ˆR, G, Bï¼‰ï¼›thicknessï¼šç·šæ¢ç²—ç´°ï¼ˆ4 åƒç´ ï¼‰<br><br>
<b>draw_string_advanced() åƒæ•¸</b>ï¼š(x, y)ï¼šæ–‡å­—å·¦ä¸Šè§’åæ¨™ï¼›font_sizeï¼šå­—é«”å¤§å°ï¼ˆ24ï¼‰ï¼›textï¼šæ–‡å­—å…§å®¹ï¼›colorï¼šæ–‡å­—é¡è‰²ï¼ˆèˆ‡æ¡†é¡è‰²ä¸€è‡´ï¼‰<br><br>
<b>max(0, draw_y - 50) çš„ä½œç”¨</b>ï¼šç¢ºä¿æ–‡å­—ä¸æœƒç¹ªè£½åœ¨å±å¹•å¤–ï¼ˆy < 0ï¼‰ï¼›å¦‚æœæª¢æ¸¬æ¡†åœ¨é ‚éƒ¨ï¼Œæ–‡å­—æœƒè‡ªå‹•ä¿æŒåœ¨å¯è¦‹å€åŸŸ
</div>`,
            code: `# ===== ç¹ªè£½çµæœ =====
osd_img.clear()
for det in det_res:
    x1, y1, x2, y2, score, class_id = det
    draw_x = int(x1 * DISPLAY_WIDTH // AI_RGB888P_WIDTH)
    draw_y = int(y1 * DISPLAY_HEIGHT // AI_RGB888P_HEIGHT)
    draw_w = int((x2 - x1) * DISPLAY_WIDTH // AI_RGB888P_WIDTH)
    draw_h = int((y2 - y1) * DISPLAY_HEIGHT // AI_RGB888P_HEIGHT)
    
    osd_img.draw_rectangle(draw_x, draw_y, draw_w, draw_h, color=colors[int(class_id) % 10], thickness=4)
    label = labels[int(class_id)] + " {:.2f}".format(score)
    osd_img.draw_string_advanced(draw_x, max(0, draw_y-50), 24, label, color=colors[int(class_id) % 10])`,
            targets: ['hw-cpu1', 'hw-dma', 'hw-gpu', 'hw-share']
        }
    };

    // åˆ›å»ºè¡Œå·åˆ°æ¨¡å—çš„æ˜ å°„
    function createLineToModuleMap() {
        const lineToModule = {};
        for (const [key, range] of Object.entries(lineRanges)) {
            for (let i = range[0]; i <= range[1]; i++) {
                if (!lineToModule[i]) {
                    lineToModule[i] = [];
                }
                lineToModule[i].push(key);
            }
        }
        return lineToModule;
    }

    const lineToModule = createLineToModuleMap();

    function renderFullCode() {
        const lines = fullProgramCode.split('\n');
        const fullCodeText = document.getElementById('fullCodeText');
        fullCodeText.innerHTML = '';
        
        document.getElementById('totalLines').textContent = lines.length;
        
        lines.forEach((line, index) => {
            const lineNum = index + 1;
            const lineDiv = document.createElement('div');
            lineDiv.className = 'code-line';
            lineDiv.textContent = line;
            lineDiv.dataset.lineNumber = lineNum;
            
            // å¦‚æœè¯¥è¡Œå±äºæŸä¸ªæ¨¡å—ï¼Œæ·»åŠ å¯ç‚¹å‡»æ ·å¼
            if (lineToModule[lineNum]) {
                lineDiv.classList.add('clickable');
                lineDiv.title = `é»æ“Šè·³è½‰åˆ°: ${lineToModule[lineNum].map(k => content[k]?.title || k).join(', ')}`;
                lineDiv.onclick = () => handleCodeLineClick(lineNum);
            }
            
            fullCodeText.appendChild(lineDiv);
        });
        
        checkCodeCoverage();
    }

    function handleCodeLineClick(lineNum) {
        const modules = lineToModule[lineNum];
        if (modules && modules.length > 0) {
            // ä¼˜å…ˆé€‰æ‹©ä¸»è¦æ¨¡å—ï¼ˆéè¾…åŠ©æ¨¡å—ï¼‰
            const primaryModules = modules.filter(m => 
                !['globals', 'var_init', 'loop_start', 'loop_end', 'except', 'finally', 'nms_func'].includes(m)
            );
            const targetModule = primaryModules[0] || modules[0];
            
            // æŸ¥æ‰¾å¯¹åº”çš„UIå…ƒç´ å¹¶è§¦å‘ç‚¹å‡»
            const targetElement = document.querySelector(`[data-key="${targetModule}"]`);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                interact(targetModule, targetElement);
            }
        }
    }

    function highlightCodeLines(startLine, endLine) {
        const allLines = document.querySelectorAll('.code-line');
        allLines.forEach(line => line.classList.remove('highlight'));
        
        if (startLine && endLine) {
            for (let i = startLine - 1; i < endLine && i < allLines.length; i++) {
                allLines[i].classList.add('highlight');
            }
            
            if (allLines[startLine - 1]) {
                setTimeout(() => {
                    allLines[startLine - 1].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 100);
            }
            
            document.getElementById('lineIndicator').textContent = `ç¬¬ ${startLine}-${endLine} è¡Œ`;
        } else {
            document.getElementById('lineIndicator').textContent = 'é»æ“Šå·¦å´æˆ–ä»£ç¢¼è¡ŒæŸ¥çœ‹å°æ‡‰æ¨¡å¡Š';
        }
    }

    function interact(key, el) {
        document.querySelectorAll('.box, .sub-box').forEach(b => b.classList.remove('active'));
        el.classList.add('active');

        const data = content[key];
        const panel = document.getElementById('detailPanel');
        document.getElementById('dHeader').textContent = data.title;
        document.getElementById('dText').innerHTML = data.text;
        document.getElementById('dCode').textContent = data.code;
        
        panel.style.display = 'block';

        document.querySelectorAll('.hw-block').forEach(b => b.classList.remove('highlight-hw'));
        
        if (data.targets) {
            data.targets.forEach(targetId => {
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.classList.add('highlight-hw');
                }
            });
        }

        const range = lineRanges[key];
        if (range) {
            highlightCodeLines(range[0], range[1]);
        } else {
            highlightCodeLines(null, null);
        }
    }

    function checkCodeCoverage() {
        const totalLines = fullProgramCode.split('\n').length;
        const coveredLines = new Set();
        
        for (const [key, range] of Object.entries(lineRanges)) {
            for (let i = range[0]; i <= range[1]; i++) {
                coveredLines.add(i);
            }
        }
        
        const uncoveredLines = [];
        for (let i = 1; i <= totalLines; i++) {
            if (!coveredLines.has(i)) {
                uncoveredLines.push(i);
            }
        }
        
        const coveragePercent = ((coveredLines.size / totalLines) * 100).toFixed(1);
        
        if (uncoveredLines.length > 0) {
            const warningDiv = document.getElementById('coverageWarning');
            const detailsDiv = document.getElementById('coverageDetails');
            
            let uncoveredRanges = [];
            let rangeStart = uncoveredLines[0];
            let rangeEnd = uncoveredLines[0];
            
            for (let i = 1; i < uncoveredLines.length; i++) {
                if (uncoveredLines[i] === rangeEnd + 1) {
                    rangeEnd = uncoveredLines[i];
                } else {
                    uncoveredRanges.push(rangeStart === rangeEnd ? `${rangeStart}` : `${rangeStart}-${rangeEnd}`);
                    rangeStart = uncoveredLines[i];
                    rangeEnd = uncoveredLines[i];
                }
            }
            uncoveredRanges.push(rangeStart === rangeEnd ? `${rangeStart}` : `${rangeStart}-${rangeEnd}`);
            
            detailsDiv.innerHTML = `
                <p><b>ä»£ç¢¼è¦†è“‹ç‡ï¼š${coveragePercent}%</b>ï¼ˆ${coveredLines.size}/${totalLines} è¡Œï¼‰</p>
                <p>æœªè¦†è“‹çš„è¡Œæ•¸ï¼š${uncoveredLines.length} è¡Œ</p>
                <ul>
                    ${uncoveredRanges.map(range => `<li>ç¬¬ ${range} è¡Œ</li>`).join('')}
                </ul>
            `;
            warningDiv.style.display = 'block';
        }
        
        console.log('âœ“ ä»£ç¢¼è¦†è“‹æª¢æŸ¥å®Œæˆ');
        console.log(`  ç¸½è¡Œæ•¸: ${totalLines}`);
        console.log(`  å·²è¦†è“‹: ${coveredLines.size} è¡Œ (${coveragePercent}%)`);
        console.log(`  æœªè¦†è“‹: ${uncoveredLines.length} è¡Œ`);
        if (uncoveredLines.length > 0) {
            console.log('  æœªè¦†è“‹è¡Œè™Ÿ:', uncoveredLines.join(', '));
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        renderFullCode();
        console.log('âœ“ å®Œæ•´ä»£ç¢¼å·²åŠ è¼‰ï¼Œå…±', fullProgramCode.split('\n').length, 'è¡Œ');
        console.log('âœ“ é›™å‘äº’å‹•åŠŸèƒ½å·²å•Ÿç”¨');
    });
</script>

</body>
</html>